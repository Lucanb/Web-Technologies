var shared;
(function(h){var e=h.utils||(h.utils={}),g=require("bintrees").RBTree,d=function(b){e.dassert(e.isValue(b));this._size=0;this._hashfn=b;this._tree=new g(function(a,b){return a.hash-b.hash})};d.prototype.size=function(){return this._size};d.prototype.find=function(b){e.dassert(e.isValue(b));var a=this._hashfn(b),a=this._tree.find({hash:a});if(null!==a)for(var f=0;f<a.values.length;f++)if(e.isEqual(b,a.values[f].key))return a.values[f].value;return null};d.prototype.insert=function(b,a){e.dassert(e.isValue(b));e.dassert(e.isValue(a));
var f=this._hashfn(b),c=this._tree.find({hash:f});if(null!==c){for(var f=null,d=0;d<c.values.length;d++)if(null===c.values[d].key)null===f&&(f=d);else if(e.isEqual(b,c.values[d].key))return!1;null!==f?c.values[f]={key:b,value:a}:c.values.push({key:b,value:a})}else this._tree.insert({hash:f,values:[{key:b,value:a}]});this._size++;return!0};d.prototype.findOrInsert=function(b,a){"undefined"===typeof a&&(a={});var f=this.find(b);if(null!==f)return f;this.insert(b,a);return a};d.prototype.remove=function(b){e.dassert(e.isValue(b));
var a=this._hashfn(b),a=this._tree.find({hash:a});if(null!==a)for(var f=0;f<a.values.length;f++)if(e.isEqual(b,a.values[f].key))return a.values[f].key=null,a.values[f].value=null,this._size--,!0;return!1};d.prototype.apply=function(b){for(var a=this._tree.iterator();a.next();)for(var f=a.data(),c=0;c<f.values.length;c++)if(null!==f.values[c].key&&!1===b(f.values[c].key,f.values[c].value))return!1;return!0};d.prototype.removeAll=function(){this._tree.clear();this._size=0};e.Map=d;h=function(b){"undefined"===
typeof b&&(b=[]);this._map=new d(function(a){return e.hash(a.toString())});for(var a=this._id=0;a<b.length;a++)this.put(b[a])};h.prototype.put=function(b){(b=this._map.insert(b,this._id))&&this._id++;return b};h.prototype.has=function(b){return null!==this._map.find(b)};h.prototype.id=function(b){return this._map.find(b)};h.prototype.remove=function(b){return this._map.remove(b)};h.prototype.size=function(){return this._map.size()};h.prototype.removeAll=function(){return this._map.removeAll()};h.prototype.apply=
function(b){return this._map.apply(function(a){return b(a)})};e.StringSet=h;var c=function(){this._elems=[]};c.prototype.size=function(){return this._elems.length};c.prototype.empty=function(){return 0===this.size()};c.prototype.front=function(){return this.at(0)};c.prototype.back=function(){return this.at(this.size()-1)};c.prototype.at=function(b){e.dassert(0<=b&&b<this.size());return this._elems[b]};c.prototype.setAt=function(b,a){e.dassert(0<=b&&b<this.size());this._elems[b]=a};c.prototype.push=
function(b){this._elems.push(b)};c.prototype.pop=function(){e.dassert(!this.empty());return this._elems.pop()};c.prototype.unshift=function(b){this._elems.unshift(b)};c.prototype.shift=function(){e.dassert(!this.empty());return this._elems.shift()};c.prototype.array=function(){return this._elems};c.prototype.first=function(b){for(var a=0;a<this._elems.length;a++)if(b(this._elems[a]))return this._elems[a];return null};c.prototype.filter=function(b){for(var a=new c,f=0;f<this._elems.length;f++)b(this._elems[f])&&
a.push(this._elems[f]);return a};c.prototype.apply=function(b){for(var a=0;a<this._elems.length;a++)b(this._elems[a])};e.Queue=c})(shared||(shared={}));var __extends=this.__extends||function(h,e){function g(){this.constructor=h}g.prototype=e.prototype;h.prototype=new g};
(function(h){var e=h.utils||(h.utils={}),g=function(a){l&&c.ok(a)},d=require("fs"),c=require("assert");require("util");var b=require("cluster");e.LogLevel={INFO:1,WARN:2,FATAL:3,NONE:4};var a=function(a){this._fd=a};a.prototype.write=function(a){a=new Buffer(a);d.writeSync(this._fd,a,0,a.length,null)};e.WriteableFD=a;var f=function(a,b,f,c,j){this._to=a;this._prefix=b;this._level=f;this._debug=new e.StringSet(c);this._next=j};f.prototype.logLevel=function(){return this._level};f.prototype.isDebugLogging=
function(a){return this._debug.has(a)};f.prototype.enableDebugLogging=function(a,b){e.isValue(b)&&!b?this._debug.remove(a):this._debug.put(a)};f.prototype.disableDebugLogging=function(){this._debug.removeAll()};f.prototype.debug=function(a,b){for(var f=[],c=0;c<arguments.length-2;c++)f[c]=arguments[c+2];this.isDebugLogging(a)&&(c=a+": "+b,this.log(e.LogLevel.INFO,c,f),this._next&&this._next.log(e.LogLevel.INFO,c,f))};f.prototype.info=function(a){for(var b=[],f=0;f<arguments.length-1;f++)b[f]=arguments[f+
1];this.log(e.LogLevel.INFO,a,b);this._next&&this._next.log(e.LogLevel.INFO,a,b)};f.prototype.warn=function(a){for(var b=[],f=0;f<arguments.length-1;f++)b[f]=arguments[f+1];this.log(e.LogLevel.WARN,a,b);this._next&&this._next.log(e.LogLevel.INFO,a,b)};f.prototype.fatal=function(a){for(var b=[],f=0;f<arguments.length-1;f++)b[f]=arguments[f+1];this.log(e.LogLevel.FATAL,a,b);this._next&&this._next.log(e.LogLevel.FATAL,a,b)};f.prototype.write=function(a){this._to.write(a);this._next&&this._next.write(a)};
f.prototype.trace=function(a){for(var b=[],f=0;f<arguments.length-1;f++)b[f]=arguments[f+1];f=Error();f.name="Trace";f.message=e.dateFormat(this._prefix,a,b);Error.captureStackTrace(f,arguments.callee);this.write(f.stack+"\n")};f.prototype.log=function(a,b,f){switch(a){case e.LogLevel.INFO:this.logLevel()<=e.LogLevel.INFO&&this._to.write(e.dateFormat(this._prefix+" INFO",b,f));break;case e.LogLevel.WARN:this.logLevel()<=e.LogLevel.WARN&&this._to.write(e.dateFormat(this._prefix+" WARNING",b,f));break;
case e.LogLevel.FATAL:if(this.logLevel()<=e.LogLevel.FATAL&&(a=e.dateFormat(this._prefix+" FATAL",b,f),this._to.write(a),!e.isValue(this._next)))throw Error("Fatal error: "+a);break;case e.LogLevel.NONE:break;default:g(!1)}this._next&&this._next.log(e.LogLevel.INFO,b,f)};e.Logger=f;h=function(a,b,c,j,d){a=this.openLog(a);f.call(this,a,b,c,j,d)};__extends(h,f);h.prototype.openLog=function(b){for(var f=0;;){var c=b+"-"+process.pid+"-"+f;try{var j=d.openSync(c,"ax","0666");return new a(j)}catch(l){if(f++,
10===f)throw l;}}};e.FileLogger=h;var j=null;e.setdefaultLogger=function(a){g(e.isValue(a));j=a};e.defaultLogger=function(){if(!j){var a="master";b.worker&&(a="work "+b.worker.id);j=new f(process.stdout,a,e.LogLevel.INFO,[])}return j};var l=!0;e.enableAsserts=function(a){l=a};e.assertsEnabled=function(){return l};e.dassert=g})(shared||(shared={}));
(function(h){var e=h.utils||(h.utils={}),g=function(a){return void 0!==a&&null!==a},d=function(a){return a&&"object"===typeof a&&!(a instanceof Array)},c=function(a){return a&&"object"===typeof a&&a instanceof Array},b=function(a){e.dassert(c(a));return a.slice(0)},a=function(a){e.dassert(d(a));var b={},f;for(f in a)b[f]=a[f];return b},f=function(a,b,f){var c="";null!==a&&0<a.length&&(c+=a+" ");var j=0,d=f.length;a=c+String(b).replace(/%[sdj%]/g,function(a){if("%%"===a)return"%";if(j>=d)return a;
switch(a){case "%s":return String(f[j++]);case "%d":return Number(f[j++]).toString();case "%j":return JSON.stringify(f[j++]);default:return a}});a+="\n";for(b=f[j];j<d;b=f[++j])a=null===b||"object"!==typeof b?a+(b+"\n"):a+(JSON.stringify(b,null," ")+"\n");return a},j=require("underscore"),l=require("os");e.hash=function(a,b){e.dassert(g(a));var f=5381;g(b)&&(f=b);for(var c=a.length,j=0;j<c;j++)f=(f<<5)-f+a.charCodeAt(j),f&=f;return f};e.isEqual=function(a,b){return j.isEqual(a,b)};e.isValue=g;e.isObject=
d;e.isArray=c;e.isObjectOrArray=function(a){return a&&"object"===typeof a};e.typeOf=function(a){var b=typeof a;"object"===b&&(a?a instanceof Array&&(b="array"):b="null");return b};e.treatAs=function(a){var b=typeof a;if("object"===b){if(a)return Object.prototype.toString.call(a).match(/^\[object\s(.*)\]$/)[1];b="null"}return b};e.cloneArray=b;e.cloneObject=a;e.clone=function(f){return d(f)?a(f):b(f)};e.toInteger=function(a){a=+a;return isNaN(a)?0:0===a||Infinity===a||-Infinity==a?a:0>a?-1*Math.floor(-a):
Math.floor(a)};e.dateFormat=function(a,b,c){return(new Date).toISOString()+" "+f(a,b,c)};e.format=f;var v=null;e.hostInfo=function(){if(null===v){v=l.hostname();var a=l.networkInterfaces(),b;for(b in a){var f=0;a[b].forEach(function(a){"IPv4"===a.family&&"127.0.0.1"!==a.address&&(v+=" ["+a.address+"]",++f)})}}return v};e.exceptionInfo=function(a){return a instanceof Error?a.stack:JSON.stringify(a)}})(shared||(shared={}));
(function(h){var e=h.utils||(h.utils={}),g=function(){return new b},d=function(a){return a instanceof b},c=function(a){var c=new b(a);e.dassert(d(c)&&c.toString()==a.toLowerCase());return c},b=require("mongodb").ObjectID;e.uidStringLength=24;e.UID=g;e.isUID=d;e.makeUID=c;e.toObjectID=function(a){return a};var a=function(){this._id=null};a.prototype.id=function(){null===this._id&&(this._id=g());return this._id};e.UniqueObject=a;a=function(){this._map=new h.utils.Map(h.utils.hash)};a.prototype.size=
function(){return this._map.size()};a.prototype.find=function(a){return this._map.find(a.toString())};a.prototype.insert=function(a,b){return this._map.insert(a.toString(),b)};a.prototype.findOrInsert=function(a,b){"undefined"===typeof b&&(b={});return this._map.findOrInsert(a.toString(),b)};a.prototype.remove=function(a){return this._map.remove(a.toString())};a.prototype.apply=function(a){return this._map.apply(function(b,d){return a(c(b),d)})};a.prototype.removeAll=function(){this._map.removeAll()};
e.IdMap=a})(shared||(shared={}));
(function(h){var e=h.types||(h.types={}),g=h.utils.UniqueObject,d=function(b,a){g.call(this);this._isobj=b;this._props=a};__extends(d,g);d.prototype.isobj=function(){return this._isobj};d.prototype.isarray=function(){return!this._isobj};d.prototype.props=function(){return this._props};d.prototype.typeDesc=function(){var b="o#";this.isarray()&&(b="a#");for(var a=0;a<this._props.length;a++)b+=this._props[a],b+="#";return b};e.TypeDesc=d;var c=function(){h.utils.dassert(null==c._instance);this._tree=
new h.utils.Map(h.utils.hash)};c.instance=function(){c._instance||(c._instance=new c);return c._instance};c.prototype.type=function(b){h.utils.dassert(h.utils.isObjectOrArray(b));var a=c.props(b),f=this._tree.find(a);null===f&&(f=a.split("#"),f.shift(),f.pop(),f=new d(h.utils.isObject(b),f),this._tree.insert(a,f));return f};c.props=function(b){h.utils.dassert(h.utils.isObjectOrArray(b));var a="o#";b instanceof Array&&(a="a#");for(var f in b)b.hasOwnProperty(f)&&(a+=f,a+="#");return a};e.TypeStore=
c})(shared||(shared={}));
(function(h){var e=h.serial||(h.serial={}),g=function(a,b,c){"undefined"===typeof c&&(c="");h.utils.dassert(h.utils.isObject(a));var d=h.utils.treatAs(b);switch(d){case "null":c+="null";break;case "undefined":c+="undefined";break;case "number":case "Number":case "boolean":case "Boolean":c+=b.toString();break;case "string":case "String":c+=JSON.stringify(b);break;case "Date":c+=JSON.stringify(b.toString());break;case "Object":case "Array":c+="<"+a.valueId(b)+">";break;case "function":case "RegExp":case "Error":c+="null";
break;default:h.utils.defaultLogger().fatal("Unexpected type: %s",d)}return c},d=function(a){h.utils.dassert(h.utils.isUID(a));this._id=a};d.prototype.id=function(){return this._id};e.Reference=d;e.writeObject=function(a,b,c,d){"undefined"===typeof c&&(c="");"undefined"===typeof d&&(d=!1);h.utils.dassert(h.utils.isObjectOrArray(a));h.utils.dassert(h.utils.isObjectOrArray(b));c=b instanceof Array?c+"[":c+"{";d&&(c+=a.valueId(b)+" ",c+=a.valueRev(b)+" ");d=Object.keys(b);for(var e=0;e<d.length;e++)c=
g(a,d[e],c),c+=":",c=g(a,b[d[e]],c),e<d.length-1&&(c+=",");return c=b instanceof Array?c+"]":c+"}"};e.writeValue=g;e.readObject=function(a,b){h.utils.dassert(1<a.length&&("["===a.charAt(0)||"{"===a.charAt(0))&&("]"===a.charAt(a.length-1)||"}"===a.charAt(a.length-1)));"{"===a.charAt(0)?h.utils.isValue(b)?h.utils.dassert(h.utils.isObject(b)):b={}:h.utils.isValue(b)?(h.utils.dassert(h.utils.isArray(b)),b.length=0):b=[];for(var j=new c(a.substr(1,a.length-2)),d=Object.keys(b),g=0;;){j.skipWS();if(j.eof())break;
var e=j.readNextValue();h.utils.dassert("string"===typeof e);if(-1!==g&&e!=d[g]){for(;g<d.length;g++)delete b[d[g]];g=-1}j.skipWS();h.utils.dassert(!j.eof());h.utils.dassert(":"===j.peek());j.skip();j.skipWS();var n=j.readNextValue();b[e]=n;j.skipWS();if(j.eof())break;else h.utils.dassert(","===j.peek()),j.skip(),j.skipWS()}return b};e.readValue=function(a){h.utils.dassert(h.utils.isValue(a));return(new c(a)).readNextValue()};var c,b=function(a){h.utils.dassert(h.utils.isValue(a));this._from=a;this._at=
0};b._numberPat=/^-?(0|([1-9][0-9]*))(\.[0-9]+)?([eE][-+][0-9]+)?/;b.prototype.eof=function(){return this._at>=this._from.length};b.prototype.skip=function(a){"undefined"===typeof a&&(a=1);this._at+=a};b.prototype.skipWS=function(){for(;this._at<this._from.length&&(" "===this._from[this._at]||"\t"===this._from[this._at]);)this._at++};b.prototype.peek=function(a){"undefined"===typeof a&&(a=0);h.utils.dassert(this._at+a<this._from.length);return this._from[this._at+a]};b.prototype.readNextValue=function(){if("null"===
this._from.substr(this._at,4))return this._at+=4,null;if("undefined"===this._from.substr(this._at,9))this._at+=9;else{if("true"===this._from.substr(this._at,4))return this._at+=4,!0;if("false"===this._from.substr(this._at,5))return this._at+=5,!1;if("NaN"===this._from.substr(this._at,3))return this._at+=3,NaN;if("Infinity"===this._from.substr(this._at,8))return this._at+=8,Infinity;if("-Infinity"===this._from.substr(this._at,9))return this._at+=9,-Infinity;if('"'===this._from.charAt(this._at)){for(var a=
this._at+1;a<this._from.length;){if("\\"===this._from.charAt(a))a+=1;else if('"'===this._from.charAt(a))break;a+=1}if(a<this._from.length){var b=this._from.substr(this._at,a-this._at+1);this._at=a+1;return JSON.parse(b)}}if("<"===this._from.charAt(this._at)&&">"===this._from.charAt(this._at+1+h.utils.uidStringLength))return a=this._from.substr(this._at+1,h.utils.uidStringLength),this._at+=2+h.utils.uidStringLength,new d(h.utils.makeUID(a));if(a=this.numberLength())return b=parseFloat(this._from.substr(this._at)),
h.utils.dassert(!isNaN(b)),this._at+=a,b;h.utils.defaultLogger().fatal("Unexpected value encoding: %s",this._from.substr(this._at))}};b.prototype.numberLength=function(){var a=b._numberPat.exec(this._from.substr(this._at));return a?a[0].length:0};c=b})(shared||(shared={}));
(function(h){var e=h.tracker||(h.tracker={}),g=function(a){return void 0===a._tracker?null:a._tracker},d=function(a){h.utils.dassert(h.utils.isObject(a._tracker));return a._tracker},c=function(a,b){var c=a.toString(),f=b.toString();return c<f?-1:c>f?1:0},b=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);return void 0!=c.get&&void 0!=c.set},a=function(a,b){var c=Object.getOwnPropertyDescriptor(a,b);void 0!=c.get&&void 0!=c.set&&Object.defineProperty(a,b,{value:a[b]})};require("buffer");var f=
function(a,b,c){this._id=a;this._prop=b;this._missing=c};f.prototype.id=function(){return this._id};f.prototype.prop=function(){return this._prop};f.prototype.missing=function(){return this._missing};e.UnknownReference=f;e.getTrackerUnsafe=g;e.getTracker=d;e.isTracked=function(a){return h.utils.isObject(a._tracker)};var j=function(f,j,g,e){"undefined"===typeof g&&(g=h.utils.UID());h.utils.dassert(h.utils.isObject(f));h.utils.dassert(h.utils.isUID(g));(null===j||"object"!==typeof j)&&h.utils.defaultLogger().fatal("Trying to track non-object/array type");
j.hasOwnProperty("_tracker")&&h.utils.defaultLogger().fatal("Trying to track already tracked object or array");this._tc=f;this._rev=e||0;this._id=g;this._lastTx=-1;this._id=g;this._type=h.types.TypeStore.instance().type(j);this._userdata=null;this._ref=0;Object.defineProperty(j,"_tracker",{value:this});j instanceof Array&&(Object.defineProperty(j,"shift",{enumerable:!1,configurable:!1,value:function(){var a=d(j);if(0===a.tc().disable){a.tc().disable++;var c=Object.keys(j),f=[];c.forEach(function(a,
c,d){f.push(b(j,d[c]))});0<j.length&&a.addShift(j,0,1);for(var l=Array.prototype.shift.apply(j,arguments),c=Object.keys(j),g=0;g<j.length;g++){var e=c[g];f[g+1]&&!b(j,e)&&a.track(j,e)}a.tc().disable--;return l}return Array.prototype.shift.apply(j,arguments)}}),Object.defineProperty(j,"unshift",{enumerable:!1,configurable:!1,value:function(){var a=d(j);if(0===a.tc().disable){a.tc().disable++;var c=Object.keys(j),f=[];c.forEach(function(a,c,d){f.push(b(j,d[c]))});0<arguments.length&&a.addUnshift(j,
0,arguments.length);for(var l=Array.prototype.unshift.apply(j,arguments),g=0;g<arguments.length;g++)a.track(j,g+""),a.addNew(j,g+"",j[g]);for(c=Object.keys(j);g<j.length;g++){var e=c[g];f[g-arguments.length]&&!b(j,e)&&a.track(j,e)}a.tc().disable--;return l}return Array.prototype.unshift.apply(j,arguments)}}),Object.defineProperty(j,"reverse",{enumerable:!1,configurable:!1,value:function(){var c=d(j);if(0===c.tc().disable){c.tc().disable++;var f=Object.keys(j),l=[];f.forEach(function(a,c,f){l.push(b(j,
f[c]))});l.reverse();c.addReverse(j);for(var g=Array.prototype.reverse.apply(j,arguments),f=Object.keys(g),e=0;e<f.length;e++){var h=f[e],q=b(j,h);l[e]&&!q?c.track(j,h):!l[e]&&q&&a(j,h)}c.tc().disable--;return g}return Array.prototype.reverse.apply(j,arguments)}}),Object.defineProperty(j,"sort",{enumerable:!1,configurable:!1,value:function(f){var l=d(j);if(0===l.tc().disable){l.tc().disable++;var g=Object.keys(j),e=[];g.forEach(function(a,c,f){e.push({elem:j[f[c]],track:b(j,f[c])})});var h=f;void 0===
h&&(h=c);var q=function(a,b){return h(a.elem,b.elem)};Array.prototype.sort.apply(e,[q]);for(f=0;f<e.length;f++){q=g[f];j[q]=e[f].elem;var n=b(j,q);e[f].track&&!n?l.track(j,q):!e[f].track&&n&&a(j,q)}l.addSort(j);l.tc().disable--;return j}Array.prototype.sort.apply(e,[q])}}),Object.defineProperty(j,"splice",{enumerable:!1,configurable:!1,value:function(){var c=d(j);if(0===c.tc().disable){c.tc().disable++;var f=j.length,l=h.utils.toInteger(arguments[0]),l=0>l?Math.max(f+l,0):Math.min(l,f),g=f-l;void 0!==
arguments[1]&&(g=Math.min(Math.max(h.utils.toInteger(arguments[1]),0),f-l));var f=Math.max(arguments.length-2,0),e=Object.keys(j),q=[];e.forEach(function(a,c,f){q.push(b(j,f[c]))});for(var n=Array.prototype.splice.apply(j,arguments),r=0;r<e.length;r++){var t=+e[r];if(t<l||t>=l+g){t>=l&&(t+=f-g);var t=t+"",y=b(j,t);q[r]&&!y?c.track(j,t):!q[r]&&y&&a(j,t)}}for(r=l;r<l+f;r++)void 0!==j[r]&&a(j,r+"");0<g&&c.addShift(j,l,g);0<f&&c.addUnshift(j,l,f);c.tc().disable--;return n}return Array.prototype.splice.apply(j,
arguments)}}));for(var r in j)this.track(j,r)};j.prototype.kill=function(){this._tc=null};j.prototype.isDead=function(){return null===this._tc};j.prototype.tc=function(){return this._tc};j.prototype.id=function(){return this._id};j.prototype.type=function(){return this._type};j.prototype.rev=function(a){void 0!==a&&(this._rev+=a);return this._rev};j.prototype.setRev=function(a){a>=this._rev&&(this._rev=a);return this._rev};j.prototype.ref=function(a){void 0!==a&&(this._ref+=a);return this._ref};j.prototype.setRef=
function(a){a>=this._ref&&(this._ref=a);return this._ref};j.prototype.setData=function(a){this._userdata=a};j.prototype.getData=function(){return this._userdata};j.prototype.hasChanges=function(){return-1!=this._lastTx};j.prototype.lastChange=function(){return this._lastTx};j.prototype.setLastChange=function(a){this._lastTx=a};j.prototype.addNew=function(a,b,c){h.utils.dassert(d(a)===this);this._lastTx=this.tc().addNew(a,b,c,this._lastTx)};j.prototype.addWrite=function(a,b,c,f){h.utils.dassert(d(a)===
this);this._lastTx=this.tc().addWrite(a,b,c,f,this._lastTx)};j.prototype.addDelete=function(a,b){h.utils.dassert(d(a)===this);this._lastTx=this.tc().addDelete(a,b,this._lastTx)};j.prototype.addReverse=function(a){h.utils.dassert(d(a)===this);this._lastTx=this.tc().addReverse(a,this._lastTx)};j.prototype.addSort=function(a){h.utils.dassert(d(a)===this);this._lastTx=this.tc().addSort(a,this._lastTx)};j.prototype.addShift=function(a,b,c){h.utils.dassert(d(a)===this);this._lastTx=this.tc().addShift(a,
b,c,this._lastTx)};j.prototype.addUnshift=function(a,b,c){h.utils.dassert(d(a)===this);this._lastTx=this.tc().addUnshift(a,b,c,this._lastTx)};j.prototype.retrack=function(a){h.utils.dassert(d(a)===this);for(var c in a)b(a,c)||this.track(a,c);this._type=h.types.TypeStore.instance().type(a)};j.prototype.track=function(a,b){h.utils.dassert(d(a)===this);if(a.hasOwnProperty(b)){var c=a[b];if(delete a[b]){var j=c,e=d(a);Object.defineProperty(a,b,{enumerable:!0,configurable:!0,get:function(){if(0===e.tc().disable&&
null!==j&&"object"===typeof j){if(j instanceof h.serial.Reference){var a=j;throw new f(e.id(),b,a.id());}a=g(j);if(null!==a){if(a.isDead())throw new f(e.id(),b,a.id());e.tc().markRead(j)}}return j},set:function(c){0===e.tc().disable&&(e.tc().disable++,e.addWrite(a,b,c,j),e.tc().disable--);j=c}})}else throw Error("Unwrappable property found: "+b);}};j.prototype.uprev=function(a){h.utils.dassert(d(a)===this);this._rev+=1;this._type=h.types.TypeStore.instance().type(a)};j.prototype.downrev=function(a){h.utils.dassert(d(a)===
this);-1!==this._lastTx&&(this._lastTx=-1,this._rev-=1,this._type=h.types.TypeStore.instance().type(a))};e.Tracker=j;e.isPropTracked=b})(shared||(shared={}));
(function(h){var e=h.mtx||(h.mtx={}),g=function(){this._map=new h.utils.IdMap};g.prototype.size=function(){return this._map.size()};g.prototype.find=function(a){return this._map.find(a)};g.prototype.insert=function(a,b){return this._map.insert(a,b)};g.prototype.remove=function(a){return this._map.remove(a)};g.prototype.apply=function(a){return this._map.apply(function(b,c){return a(b,c)})};g.prototype.removeAll=function(){this._map.removeAll()};g.prototype.toString=function(){var a="";this._map.apply(function(b,
c){a+=b;a+=" ";a+=c;a+="\n";return!0});return a};e.ReadMap=g;var d=function(a){"undefined"===typeof a&&(a=new h.utils.Queue);this._queue=a};d.prototype.size=function(){return this._queue.size()};d.prototype.empty=function(){return this._queue.empty()};d.prototype.front=function(){return this._queue.front()};d.prototype.back=function(){return this._queue.back()};d.prototype.at=function(a){return this._queue.at(a)};d.prototype.setAt=function(a,b){this._queue.setAt(a,b)};d.prototype.push=function(a){this._queue.push(a)};
d.prototype.pop=function(){return this._queue.pop()};d.prototype.unshift=function(a){this._queue.unshift(a)};d.prototype.shift=function(){return this._queue.shift()};d.prototype.array=function(){return this._queue.array()};d.prototype.first=function(a){return this._queue.first(function(b){return a(b)})};d.prototype.filter=function(a){var b=this._queue.filter(function(b){return a(b)});return new d(b)};d.prototype.apply=function(a){this._queue.apply(function(b){return a(b)})};d.prototype.toString=function(){var a=
"";this._queue.apply(function(b){a+=b.id;a+=" ";a+=JSON.stringify(b.obj);a+="\n"});return a};e.NewQueue=d;var c=function(a){"undefined"===typeof a&&(a=new h.utils.Queue);this._queue=a};c.prototype.size=function(){return this._queue.size()};c.prototype.empty=function(){return this._queue.empty()};c.prototype.front=function(){return this._queue.front()};c.prototype.back=function(){return this._queue.back()};c.prototype.at=function(a){return this._queue.at(a)};c.prototype.setAt=function(a,b){this._queue.setAt(a,
b)};c.prototype.push=function(a){this._queue.push(a)};c.prototype.pop=function(){return this._queue.pop()};c.prototype.unshift=function(a){this._queue.unshift(a)};c.prototype.shift=function(){return this._queue.shift()};c.prototype.array=function(){return this._queue.array()};c.prototype.first=function(a){return this._queue.first(function(b){return a(b)})};c.prototype.filter=function(a){var b=this._queue.filter(function(b){return a(b)});return new c(b)};c.prototype.apply=function(a){this._queue.apply(function(b){return a(b)})};
c.prototype.toString=function(){var a="";this._queue.apply(function(b){null===b?a+="<null>":(a+=h.tracker.getTracker(b.obj).id(),a+=" ",void 0!==b.write?(a+="write "+b.write+" = "+JSON.stringify(b.value),void 0!==b.last&&(a+=" last "+JSON.stringify(b.last))):a=void 0!==b.del?a+("delete "+b.del):void 0!==b.reinit?a+("reinit "+b.reinit):void 0!==b.reverse?a+"reverse":void 0!==b.shift?a+("shift "+b.shift+" by "+b.size):void 0!==b.unshift?a+("unshift "+b.unshift+" by "+b.size):a+("**UNKNOWN** "+JSON.stringify(b)));
a+="\n"});return a};e.ChangeQueue=c;var b=function(){this.reset()};b.prototype.reset=function(){this.rset=new g;this.nset=new d;this.cset=new c};b.prototype.toString=function(){var a;a="Read:\n"+this.rset.toString();a+="New:\n"+this.nset.toString();return a+="Changed:\n"+this.cset.toString()};e.MTX=b})(shared||(shared={}));
(function(h){var e=h.mtx||(h.mtx={}),g=function(){this._cache=new h.utils.Map(h.utils.hash)};g.prototype.find=function(c){return this._cache.find(c.toString())};g.prototype.insert=function(c,b){return this._cache.insert(c.toString(),b)};g.prototype.remove=function(c){return this._cache.remove(c.toString())};e.ObjectCache=g;var d=h.utils.UniqueObject,g=function(){d.call(this);this.disable=0;this._mtx=new e.MTX;this._collected=!1};__extends(g,d);g.prototype.cset=function(){return this._mtx.cset.array()};
g.prototype.markRead=function(c){c=h.tracker.getTracker(c);h.utils.dassert(c.tc()===this);this._mtx.rset.insert(c.id(),c.rev())};g.prototype.readsetSize=function(){return this._mtx.rset.size()};g.prototype.readsetObject=function(c){return this._mtx.rset.find(c.toString())};g.prototype.newsetSize=function(){return this._mtx.nset.size()};g.prototype.newsetObject=function(c){var b=this._mtx.nset.first(function(a){return a.id.toString()===c.toString()});return b?b.obj:null};g.prototype.addNew=function(c,
b,a,f){h.utils.isObjectOrArray(a)&&this.valueId(a);"function"===typeof a&&(a=null);this._mtx.cset.push({obj:c,write:b,value:a,lasttx:f});return this._mtx.cset.size()-1};g.prototype.addWrite=function(c,b,a,f,j){h.utils.isObjectOrArray(a)&&this.valueId(a);"function"===typeof a&&(a=null);this._mtx.cset.push({obj:c,write:b,value:a,last:f,lasttx:j});return this._mtx.cset.size()-1};g.prototype.addDelete=function(c,b,a){this._mtx.cset.push({obj:c,del:b,lasttx:a});return this._mtx.cset.size()-1};g.prototype.addReverse=
function(c,b){this._mtx.cset.push({obj:c,reverse:!0,lasttx:b});return this._mtx.cset.size()-1};g.prototype.addSort=function(c,b){this._mtx.cset.push({obj:c,sort:!0,lasttx:b});return this._mtx.cset.size()-1};g.prototype.addShift=function(c,b,a,f){this._mtx.cset.push({obj:c,shift:b,size:a,lasttx:f});return this._mtx.cset.size()-1};g.prototype.addUnshift=function(c,b,a,f){this._mtx.cset.push({obj:c,unshift:b,size:a,lasttx:f});return this._mtx.cset.size()-1};g.prototype.replaceSort=function(c,b,a){h.utils.dassert(void 0!==
this._mtx.cset.at(c).sort);c=h.tracker.getTracker(b);for(var f=c.lastChange();-1!==f;){var j=f,f=this._mtx.cset.at(f).lasttx;this._mtx.cset.setAt(j,null)}this._mtx.cset.push({obj:b,reinit:a,lasttx:-1});c.setLastChange(this._mtx.cset.size()-1)};g.prototype.mtx=function(c){h.utils.dassert(!1===this._collected);this._collected=!0;this.collect(c);return this._mtx};g.prototype.resetMtx=function(){this._mtx=new e.MTX;this._collected=!1};g.prototype.okMtx=function(){this._mtx.cset.apply(function(c){null!==
c&&h.tracker.getTracker(c.obj).setLastChange(-1)});this.resetMtx()};g.prototype.undoMtx=function(c){this.disable++;this._collected||this.collect(c);for(var b=this._mtx.cset.size()-1;0<=b;){var a=this._mtx.cset.at(b);if(null!==a){var f=h.tracker.getTracker(a.obj);f.isDead()||(void 0!==a.write?void 0!==a.last?a.obj[a.write]=a.last:h.utils.isArray(a.obj)?a.obj.splice(parseInt(a.write),1):delete a.obj[a.write]:(f.kill(),c.remove(f.id())))}b--}for(b=this._mtx.cset.size()-1;0<=b;)a=this._mtx.cset.at(b),
null!==a&&(f=h.tracker.getTracker(a.obj),f.downrev(a.obj)),b--;this.resetMtx();this.disable--};g.prototype.valueId=function(c){h.utils.dassert(h.utils.isObjectOrArray(c));var b=h.tracker.getTrackerUnsafe(c);if(null===b){if(void 0===c._pid){for(var b=Object.keys(c),a=0;a<b.length;a++){var f=b[a];h.utils.isObjectOrArray(c[f])&&this.valueId(c[f])}Object.defineProperty(c,"_pid",{value:h.utils.UID()});this._mtx.nset.push({id:c._pid,obj:c})}return c._pid}b.tc()!==this&&h.utils.defaultLogger().fatal("Objects can not be used in multiple stores");
return c._tracker.id()};g.prototype.valueRev=function(c){return void 0===c._tracker?0:c._tracker.rev()};g.prototype.collect=function(c){var b=this;this._mtx.rset.apply(function(a){a=c.find(a);h.utils.dassert(null!=a);b.collectObject(a);return!0})};g.prototype.collectObject=function(c){h.utils.dassert(h.tracker.isTracked(c));c instanceof Array?this.arrayChanges(c):this.objectChanges(c)};g.prototype.objectChanges=function(c){var b=h.tracker.getTracker(c);b.tc().disable++;for(var a=h.utils.cloneArray(b.type().props()),
f=Object.keys(c),j=0;j<a.length;j++)if(!c.hasOwnProperty(a[j])||!h.tracker.isPropTracked(c,a[j]))b.addDelete(c,a[j]);else{var d=f.indexOf(a[j]);f[d]=null}for(j=0;j<f.length;j++)null!==f[j]&&(b.addNew(c,f[j],c[f[j]]),b.track(c,f[j]));b.hasChanges()&&b.uprev(c);b.tc().disable--};g.prototype.arrayChanges=function(c){var b=h.tracker.getTracker(c);b.tc().disable++;for(var a=b.lastChange(),f=[];-1!==a;){if(void 0!==this._mtx.cset.at(a).sort){var j=h.serial.writeObject(b.tc(),c,"");this.replaceSort(a,c,
j);b.uprev(c);b.tc().disable--;return}f.unshift(this._mtx.cset.at(a));a=this._mtx.cset.at(a).lasttx}for(var j=h.utils.cloneArray(b.type().props()),d=0;d<f.length;d++)if(void 0!=f[d].shift)for(var a=f[d].shift,g=f[d].size,e=0;e!==j.length;){var n=+j[e];n>=a&&n<a+g?j.splice(e,1):(n>=a+g&&(j[e]=n-g+""),e++)}else if(void 0!=f[d].unshift){for(var a=f[d].unshift,g=f[d].size,e=0,r=!1;e!==j.length;)if(n=+j[e],r)j[e]=n+g+"",e++;else if(n>=a){for(n=g-1;0<=n;n--)j.splice(e,0,a+n+"");r=!0;e+=g}else e++;if(!r)for(n=
0;n<g;n++)j.push(a+n+"")}a=0;for(d=j.length-1;0<=d;d--)if(+j[d]>=c.length)a++;else break;if(0<a)for(b.addShift(c,-1,+j[j.length-1]-c.length+1);0<a;)j.pop(),a--;for(d=0;d<j.length;d++)c.hasOwnProperty(j[d])?h.tracker.isPropTracked(c,j[d])||(b.addNew(c,j[d],c[j[d]]),b.track(c,j[d])):b.addDelete(c,j[d]);a=Object.keys(c);for(d=0;d<a.length;d++)n=j.indexOf(a[d]),-1===n&&(b.addNew(c,a[d],c[a[d]]),b.track(c,a[d]));b.hasChanges()&&b.uprev(c);b.tc().disable--};e.mtxFactory=g})(shared||(shared={}));
(function(h){var e=h.store||(h.store={});require("util");var g=require("rsvp"),d=require("mongodb"),c=require("bson"),b=h.utils.makeUID("000000000000000000000000"),a=h.mtx.mtxFactory,f=function(b){"undefined"===typeof b&&(b={});a.call(this);this._logger=h.utils.defaultLogger();this._collection=null;this._pending=[];this._root=null;this._cache=new h.mtx.ObjectCache;this._host=b.host||"localhost";this._port=b.port||27017;this._dbName=b.db||"shared";this._collectionName=b.collection||"shared";this._safe=
b.safe||"false";this._logger.debug("STORE","%s: Store created",this.id())};__extends(f,a);f.prototype.close=function(){this._pending.push({close:!0});this.processPending()};f.prototype.apply=function(a,b){"undefined"===typeof b&&(b=function(){});this._pending.push({handler:a,callback:b});this.processPending()};f.prototype.processPending=function(a){"undefined"===typeof a&&(a=!1);var b=this;if(a&&0<b._pending.length||!a&&1===b._pending.length){var c=b._pending[0];c.close?(b._db&&(b._db.close(),b._collection=
null,b._db=null,b._logger.debug("STORE","%s: Database has been closed",b.id())),b._pending.shift()):b.getRoot().then(function(){b.tryHandler(c.handler).then(function(a){b._logger.debug("STORE","%s: Invoking user callback",b.id());c.callback(null,a);b._pending.shift();b.processPending(!0)},function(a){a&&(b._logger.debug("STORE","%s: Invoking user callback with error %j",b.id(),a),c.callback(a,null),b._pending.shift());b.processPending(!0)})},function(a){b._logger.debug("STORE","%s: Invoking user callback with error %j",
b.id(),a);c.callback(a,null);b._pending.shift();b.processPending(!0)})}};f.prototype.tryHandler=function(a,b){"undefined"===typeof b&&(b=new g.Promise);var c=this;try{c._logger.debug("STORE","%s: Invoking user handler",c.id());c.markRead(c._root);var f=a(c._root);try{c._logger.debug("STORE","%s: Attempting commit",c.id()),c.commitMtx(c.mtx(c._cache)).then(function(){c._logger.debug("STORE","%s: Update completed successfully",c.id());c.okMtx(c._cache);b.resolve(f)},function(a){h.utils.isArray(a)?0!==
a.length&&(c._logger.debug("STORE","Objects need refresh after commit failure"),c.undo(),c.locked(function(){return c.refreshSet(a)}).then(function(){c._logger.debug("STORE","Starting re-try");b.reject(null)},function(a){b.reject(a)})):b.reject(a)})}catch(d){c._logger.fatal("Unhandled exception",h.utils.exceptionInfo(d))}}catch(e){if(c._logger.debug("STORE","Exception during try: ",h.utils.exceptionInfo(e)),c.undo(),e instanceof h.tracker.UnknownReference){var k=c._cache.find(e.missing());if(null===
k)k=c.getCollection(),k=c.wait(k,function(){return c.locked(function(){var a=c.getObject(e.missing());return a=c.wrap(a,function(a){if(void 0!==e.id()){var f=c._cache.find(e.id());null!==f&&(c.disable++,f[e.prop()]=a,c.disable--,b.reject(null))}})})});else{var p=this._cache.find(e.id());c.disable++;p[e.prop()]=k;c.disable--;b.reject(null)}}else b.reject(e)}return b};f.prototype.commitMtx=function(a){h.utils.dassert(h.utils.isValue(a));this._logger.debug("STORE","%s: commitMtx()",this.id(),a.toString());
var b=this;return b.locked(function(){return b.applyMtx(a)})};f.prototype.applyMtx=function(a){var b=this,c=new g.Promise;b.checkReadset(a.rset).then(function(a){a=a.filter(function(a){return null!==a});0<a.length?(b._logger.debug("STORE","%s: checkReadset failures",b.id(),a),c.reject(a)):c.resolve()},function(a){b._logger.debug("STORE","%s: checkReadset failed",b.id());c.reject(a)});return b.wait(c,function(){return b.makeChanges(a)})};f.prototype.makeChanges=function(a){var b=this,c=new g.Promise;
c.resolve();for(var f=new h.utils.IdMap,d=a.nset,e=0;e<d.size();e++){var k=d.at(e);h.utils.dassert(null===this._cache.find(k.id));for(var p=Object.keys(k.obj),s=0;s<p.length;s++){var m=k.obj[p[s]];h.utils.isObjectOrArray(m)&&null===h.tracker.getTrackerUnsafe(m)&&(m=this.valueId(m),m=f.findOrInsert(m,{uprev:!1,ref:-1,reinit:!1}),m.ref++)}}for(e=0;e<d.size();e++)k=d.at(e),h.utils.dassert(null===this._cache.find(k.id)),c=b.wait(c,function(a,c){return function(){return b.writeObject(a,c,0,1)}}(k.id,k.obj)),
m={uprev:!1,ref:-1,reinit:!1},f.findOrInsert(k.id,{uprev:!1,ref:-1,reinit:!1}),new h.tracker.Tracker(b,k.obj,k.id,0),b._cache.insert(k.id,k.obj);a=a.cset;for(e=0;e<a.size();e++)if(k=a.at(e),null!==k){var p=h.tracker.getTracker(k.obj),d=p.id(),u=p.getData(),m=f.findOrInsert(p.id(),{uprev:!0,ref:0,reinit:!1});m.uprev=!0;if(void 0!==k.write)h.utils.isObjectOrArray(k.last)&&(m=this.objectID(k.last),f.findOrInsert(m,{uprev:!0,ref:0,reinit:!1}).ref--,u.rout--),p=k.value,h.utils.isObjectOrArray(p)&&(m=this.objectID(p),
p=new h.serial.Reference(m),f.findOrInsert(m,{uprev:!0,ref:0,reinit:!1}).ref++,u.rout++),c=b.wait(c,function(a,c,f){return function(){return b.writeProp(a,c,f)}}(d,k.write,p));else if(void 0!==k.del)0<u.rout&&(c=b.wait(c,function(a,c){return function(){return b.readProp(a,c)}}(p.id(),k.del)),c=b.wrap(c,function(a){if(h.utils.isObject(a)){var b=Object.keys(a);1===b.length&&"_id"===b[0]&&(f.findOrInsert(a._id,{uprev:!1,ref:0,reinit:!1}).ref--,u.rout--)}})),c=b.wait(c,function(a,c){return function(){return b.deleteProp(a,
c)}}(p.id(),k.del));else if(void 0!==k.shift)if(0===k.shift||-1===k.shift){m=k.size;k=0===k.shift;for(p=function(a,c){return function(){return b.arrayPop(a,c)}};m--;)c=b.wait(c,p(d,k))}else m.reinit=!0;else void 0!==k.unshift?m.reinit=!0:void 0!==k.reinit?m.reinit=!0:void 0!==k.reverse?m.reinit=!0:this._logger.fatal("%s: cset contains unexpected command",p.id())}var w=new g.Promise;c.then(function(){var a=new g.Promise;a.resolve();f.apply(function(c,f){if(f.reinit){var j=b._cache.find(c),d=h.tracker.getTracker(j),
e=d.getData();a=b.wait(a,function(a,c,f,j){return function(){return b.writeObject(a,c,f,j)}}(c,j,d.rev(),e.rin+f.ref))}else if(f.uprev||0!==f.ref)a=b.wait(a,function(a,c,f){return function(){return b.changeRevAndRef(a,c,f)}}(c,f.uprev,f.ref))});a.then(function(){w.resolve()},function(a){w.reject(a)})},function(a){w.reject(a)});return w};f.prototype.undo=function(){this.undoMtx(this._cache);h.tracker.getTracker(this._root).isDead()&&(this._root=null)};f.prototype.objectID=function(a){h.utils.dassert(h.utils.isObjectOrArray(a));
if(a instanceof h.serial.Reference)return a.id();var b=h.tracker.getTrackerUnsafe(a);return b?b.id():this.valueId(a)};f.prototype.fail=function(a,b){for(var c=[],f=0;f<arguments.length-2;f++)c[f]=arguments[f+2];c=h.utils.format("",b,c);this._logger.debug("STORE",c);a.reject(Error(c))};f.prototype.updateObject=function(a,b){"Object"===a._type?h.utils.isValue(b)?h.utils.dassert(h.utils.isObject(b)):b={}:"Array"===a._type?h.utils.isValue(b)?(h.utils.dassert(h.utils.isArray(b)),b.length=0):b=[]:this._logger.fatal("%s: Unexpected document type: %j",
this.id(),a._type);this.disable++;for(var c=Object.keys(a._data),f=0,d=Object.keys(b),e=0,g=0;f!==c.length;){var p=c[f];if(-1!==e&&p!=d[e]){for(;e<d.length;e++)delete b[d[e]];e=-1}var s=a._data[c[f]];if(h.utils.isObject(s)){var m=Object.keys(s);1===m.length&&"_id"===m[0]&&(s=new h.serial.Reference(s._id),g++)}b[p]=s;f++}this.disable--;return{obj:b,id:a._id,rev:a._rev,ref:a._ref,out:g}};f.prototype.wait=function(a,b){var c=this,f=new g.Promise;a.then(function(){b.apply(c,arguments).then(function(){f.resolve.apply(f,
arguments)},function(a){f.reject(a)})},function(a){f.reject(a)});return f};f.prototype.wrap=function(a,b){var c=this,f=new g.Promise;a.then(function(){f.resolve(b.apply(c,arguments))});return f};f.prototype.locked=function(a){var b=this,c=new g.Promise;b.lock().then(function(){a().then(function(){var a=arguments;b.removeLock().then(function(){c.resolve(a)},function(a){c.reject(a)})},function(a){b.removeLock().then(function(){c.reject(a)},function(a){c.reject(a)})})},function(a){c.reject(a)});return c};
f.prototype.getCollection=function(){var a=this,c=new g.Promise;if(null!==a._collection)return c.resolve(a._collection),c;a._logger.debug("STORE","%s: Connecting to database - %s",a.id(),a._dbName);a._db=new d.Db(a._dbName,new d.Server(a._host,a._port,{poolSize:1}),{w:1});a._db.open(function(f){f?a.fail(c,"%s: Unable to open db: %s : %s",a.id(),a._dbName,f.message):(a._logger.debug("STORE","%s: Opening collection - %s",a.id(),a._collectionName),a._db.createCollection(a._collectionName,function(f,
d){if(f)a.fail(c,"%s: Unable to open collection: %s : %s",a.id(),a._collectionName,f.message);else{a._collection=d;var g=a.ensureExists(b,{locked:!1},null),g=a.wait(g,function(){return a.ensureExists(e.rootUID,{_rev:0,_ref:1,_type:"Object",_data:{}},d)});g.then(function(){c.resolve()},function(a){c.resolve(a)})}}))});return c};f.prototype.lock=function(a){"undefined"===typeof a&&(a=1);var f=this,d=new g.Promise;f._logger.debug("STORE","%s: Trying to acquire lock",f.id());var e=h.utils.toObjectID(b),
n=(new c.ObjectId).toString();f._collection.findAndModify({_id:e,locked:!1},[],{_id:e,owner:f.id().toString(),host:h.utils.hostInfo(),pid:process.pid,rand:n,locked:!0},{safe:!0,upsert:!1,remove:!1,"new":!1},function(b,c){b?f.fail(d,"%s: Unable query lock : %s",f.id(),b.message):c?(f._logger.debug("STORE","%s: Acquired lock",f.id()),d.resolve()):100<a?f._collection.findOne({_id:e},function(b,c){b?f.fail(d,"%s: Unable query lock : %s",f.id(),b.message):(f._logger.debug("STORE","%s: Locked by: %s",f.id(),
c.host),c&&(void 0!==c.rand&&f._lockRand!==c.rand)&&(f._lockRand&&f._logger.debug("STORE","%s: Lock rand has changed, %s to %s, reseting timeout",f.id(),f._lockRand,c.rand),f._lockRand=c.rand,a=100),1E4<a?(f._logger.debug("STORE","%s: Lock owner must be dead, trying to remove",f.id()),f.removeLock().then(function(){f.lock().then(function(){d.resolve()},function(a){d.reject(a)})},function(a){d.resolve(a)})):setTimeout(function(){f.lock(2*a).then(function(){d.resolve()},function(a){d.reject(a)})},a))}):
setTimeout(function(){f.lock(2*a).then(function(){d.resolve()},function(a){d.reject(a)})},a)});return d};f.prototype.removeLock=function(){var a=this,c=new g.Promise,f=h.utils.toObjectID(b);a._collection.update({_id:f},{_id:f,locked:!1},{safe:a._safe,upsert:!0},function(b){b?a.fail(c,"%s: Unable remove lock : %s",a.id(),b.message):(a._logger.debug("STORE","%s: Released lock",a.id()),a._lockRand=null,c.resolve())});return c};f.prototype.getRoot=function(){var a=this,b=new g.Promise;null!==a._root?
b.resolve(a._root):a.getCollection().then(function(){a.lock().then(function(){a.getObject(e.rootUID).then(function(c){a.removeLock().then(function(){a._root=c;b.resolve(c)},function(a){b.reject(a)})},function(c){a.removeLock().then(function(){b.reject(c)})})},function(a){b.reject(a)})},function(a){b.reject(a)});return b};f.prototype.getObject=function(a){var b=new g.Promise,c=this;c.getCollection().then(function(f){c._logger.debug("STORE","%s: Searching for object: %s",c.id(),a);f.findOne({_id:h.utils.toObjectID(a)},
function(f,d){if(f)c.fail(b,"%s: Unable to search collection: %s : %s",c.id(),c._collectionName,f.message);else if(null===d)c.fail(b,"%s: Object missing in store: %s",c.id(),a);else{c._logger.debug("STORE","%s: Loading object: %s:%d",c.id(),a,d._rev);var g=c._cache.find(a),g=c.updateObject(d,g),q=h.tracker.getTrackerUnsafe(g.obj);null===q?(q=new h.tracker.Tracker(c,g.obj,g.id,g.rev),c._cache.insert(q.id(),g.obj)):(q.setRev(g.rev),q.retrack(g.obj));q.setData({rout:g.out,rin:d._ref});q.id().toString()===
e.rootUID.toString()&&(c._root=g.obj);b.resolve(g.obj)}})});return b};f.prototype.refreshSet=function(a){for(var b=[],c=0;c<a.length;c++)b.push(this.getObject(a[c]));return g.all(b)};f.prototype.writeObject=function(a,b,c,f){h.utils.dassert(h.utils.isValue(a)&&h.utils.isObjectOrArray(b));var d=this,e=0,k={};k._data=h.utils.clone(b);for(var p=Object.keys(b),s=0;s<p.length;s++)if(h.utils.isObjectOrArray(b[p[s]])){var m=d.valueId(b[p[s]]);k._data[p[s]]={_id:m.toString()};e++}k._id=h.utils.toObjectID(a);
k._rev=c;k._ref=f;k._type=h.utils.isObject(b)?"Object":"Array";h.tracker.getTracker(b).setData({rout:e,rin:f});var u=new g.Promise;d._logger.debug("STORE","%s: Updating object: %s %j",d.id(),a,b);d._collection.update({_id:k._id},k,{safe:d._safe,upsert:!0},function(a,c){a?d.fail(u,"%s: Update failed on new object %s=%j error %s",d.id(),m,b,a.message):d._safe&&1!==c?d.fail(u,"%s: Update failed on new object %s=%j count %d",d.id(),m,b,c):u.resolve()});return u};f.prototype.ensureExists=function(a,b,
c){var f=this,d=new g.Promise;f._logger.debug("STORE","%s: Checking/inserting for object: %s",f.id(),a);b._id=h.utils.toObjectID(a);f._collection.findOne({_id:h.utils.toObjectID(a)},function(e,g){e?f.fail(d,"%s: Unable to search collection: %s : %s",f.id(),f._collectionName,e.message):null===g?f._collection.insert(b,{safe:!0},function(b){b?f._logger.debug("STORE","%s: Unable to insert %s (ignoring as maybe race)",f.id(),a):f._logger.debug("STORE","%s: Object %s inserted",f.id(),a);d.resolve(c)}):
(f._logger.debug("STORE","%s: Object %s already exists",f.id(),a),d.resolve(c))});return d};f.prototype.changeRevAndRef=function(a,b,c){var f=this,d=new g.Promise;f._logger.debug("STORE","%s: Updating object rev & ref: %s uprev: %s, upref %d",f.id(),a,b,c);var e=0;b&&(e=1);f._collection.findAndModify({_id:h.utils.toObjectID(a)},[],{$inc:{_rev:e,_ref:c}},{safe:!0,remove:!1,upsert:!1,"new":!0},function(b,c){if(b)f.fail(d,"%s: Update failed on object ref for %s error %s",f.id(),a,b.message);else if(null===
c)f.fail(d,"%s: Update failed on object ref for %s empty doc",f.id(),a);else{var e;if(0===c._ref){e=f.deleteObject(a);for(var l=function(a){return function(){return f.changeRevAndRef(h.utils.makeUID(a),!1,-1)}},v=Object.keys(c._data),r=0;r<v.length;r++){var x=c._data[v[r]];h.utils.isObject(x)&&h.utils.isEqual(Object.keys(x),["_id"])&&(e=f.wait(e,l(x._id)))}}else e=new g.Promise,e.resolve();e.then(function(){d.resolve()},function(a){d.reject(a)})}});return d};f.prototype.deleteObject=function(a){var b=
this,c=new g.Promise;b._logger.debug("STORE","%s: Deleting object: %s",b.id(),a);b._collection.remove({_id:h.utils.toObjectID(a)},{safe:b._safe},function(f,d){f?b.fail(c,"%s: Deleting failed on %s error %s",b.id(),a,f.message):b._safe&&1!==d?b.fail(c,"%s: Deleting failed on %s count %d",b.id(),a,d):c.resolve()});return c};f.prototype.readProp=function(a,b){var c=this,f=new g.Promise,d={};d["_data."+b]=!0;c._logger.debug("STORE","%s: Reading prop for object: %s[%s]",c.id(),a,b);c._collection.findOne({_id:h.utils.toObjectID(a)},
d,function(d,e){d?c.fail(f,"%s: Unable to search collection: %s : %s",c.id(),c._collectionName,d.message):null===e?c.fail(f,"%s: Object missing in store: %s : %s",c.id(),a):f.resolve(e._data[b])});return f};f.prototype.writeProp=function(a,b,c){var f=this,d=new g.Promise;c instanceof h.serial.Reference&&(c={_id:c.id()});var e={};e["_data."+b]=c;f._logger.debug("STORE","%s: Updating property: %s[%s] %j",f.id(),a,b,c);f._collection.update({_id:h.utils.toObjectID(a)},{$set:e},{safe:f._safe},function(e,
g){e?f.fail(d,"%s: Update failed on %s[%s] %j error %s",f.id(),a,b,c,e.message):f._safe&&1!==g?f.fail(d,"%s: Update failed on %s[%s] %j count %d",f.id(),a,b,c,g):d.resolve()});return d};f.prototype.deleteProp=function(a,b){var c=this,f=new g.Promise,d={};d["_data."+b]="";c._logger.debug("STORE","%s: Deleting property: %s[%s]",c.id(),a,b);c._collection.update({_id:h.utils.toObjectID(a)},{$unset:d},{safe:c._safe},function(d,e){d?c.fail(f,"%s: Deleting failed on %s[%s] error %s",c.id(),a,b,d.message):
c._safe&&1!==e?c.fail(f,"%s: Deleting failed on %s[%s] count %d",c.id(),a,b,e):f.resolve()});return f};f.prototype.arrayPop=function(a,b){var c=this,f=new g.Promise,d=1,e="back";b&&(d=-1,e="front");c._logger.debug("STORE","%s: Array pop: %s[%s]",c.id(),a,e);c._collection.update({_id:h.utils.toObjectID(a)},{$pop:{_data:d}},{safe:c._safe},function(b,d){b?c.fail(f,"%s: Array pop failed on %s[%s] error %s",c.id(),a,e,b.message):c._safe&&1!==d?c.fail(f,"%s: Array pop failed on %s[%s] count %d",c.id(),
a,e,d):f.resolve()});return f};f.prototype.checkReadset=function(a){this._logger.debug("STORE","%s: checkReadset(%d)",this.id(),a.size());var b=this;h.utils.dassert(0!==a.size());var c=[];a.apply(function(a,f){c.push(b.revisionCheck(a,f));return!0});return g.all(c)};f.prototype.revisionCheck=function(a,b){this._logger.debug("STORE","%s: revisionCheck(%s,%s)",this.id(),a,b);var c=new g.Promise;this._collection.find({_id:h.utils.toObjectID(a),_rev:b}).count(function(b,f){b?c.reject(b.message):1===f?
c.resolve(null):c.resolve(a)});return c};e.MongoStore=f})(shared||(shared={}));(function(h){var e=h.store||(h.store={});e.rootUID=h.utils.makeUID("000000000000000000000001");e.createStore=function(g){return new e.MongoStore(g)}})(shared||(shared={}));var testtracker;
(function(h){function e(){null!==c&&c.close();c=new shared.store.MongoStore;g.defaultLogger().disableDebugLogging()}var g=shared.utils,d=shared.tracker,c=null;h.illegaltype=function(b){e();b.throws(function(){new d.Tracker(c,null)},Error);b.throws(function(){new d.Tracker(c,void 0)},Error);b.throws(function(){new d.Tracker(c,0)},Error);b.throws(function(){new d.Tracker(c,1)},Error);b.throws(function(){new d.Tracker(c,"")},Error);b.throws(function(){new d.Tracker(c,"a")},Error);b.throws(function(){new d.Tracker(c,
!0)},Error);b.throws(function(){new d.Tracker(c,!1)},Error);b.done()};h.objctor=function(b){var a={},f=new d.Tracker(c,a);b.ok("object"===typeof a._tracker);b.ok(a._tracker===f);b.ok(g.isObject(f.type()));b.done()};h.idobjctor=function(b){b.throws(function(){new d.Tracker(c,{},"1")},Error);b.throws(function(){new d.Tracker(c,{},"12")},Error);var a=new d.Tracker(c,{},g.makeUID("123456781234567812345678"));b.ok("object"==typeof a);b.ok("123456781234567812345678"==a.id().toString());b.done()};h.arrayctor=
function(b){var a=[],f=new d.Tracker(c,a);b.ok("object"===typeof a._tracker);b.ok(a._tracker===f);b.ok(g.isObject(f.type()));b.done()};h.idarrayctor=function(b){b.throws(function(){new d.Tracker(c,[],"1")},Error);b.throws(function(){new d.Tracker(c,[],"12")},Error);var a=new d.Tracker(c,{},g.makeUID("123456781234567812345678"));b.ok("object"==typeof a);b.ok("123456781234567812345678"==a.id().toString());b.done()};h.rev=function(b){var a=new d.Tracker(c,[]);b.ok(0===a.rev());b.ok(1===a.rev(1));b.ok(1===
a.rev());b.ok(2===a.rev(1));b.ok(2===a.rev());b.ok(2===a.rev());b.ok(3===a.rev(1));b.ok(4===a.rev(1));b.done()};h.wrapNumber=function(b){e();var a={a:1};new d.Tracker(c,a);b.ok("number"==typeof a.a);b.ok(1===a.a);a.a=2;b.ok(g.isEqual(c.cset()[0],{obj:a,write:"a",value:2,last:1,lasttx:-1}));b.ok(0===c.readsetSize());b.ok(0===c.newsetSize());b.ok(2===a.a);b.done()};h.wrapString=function(b){e();var a={a:"b"};new d.Tracker(c,a);b.ok("string"==typeof a.a);b.ok("b"===a.a);a.a="c";b.ok(g.isEqual(c.cset()[0],
{obj:a,write:"a",value:"c",last:"b",lasttx:-1}));b.ok(0===c.readsetSize());b.ok(0===c.newsetSize());b.ok("c"===a.a);b.done()};h.wrapBoolean=function(b){e();var a={a:!0};new d.Tracker(c,a);b.ok("boolean"==typeof a.a);b.ok(!0===a.a);a.a=!1;b.ok(g.isEqual(c.cset()[0],{obj:a,write:"a",value:!1,last:!0,lasttx:-1}));b.ok(0===c.readsetSize());b.ok(0===c.newsetSize());b.ok(!1===a.a);b.done()};h.wrapFunc=function(b){e();var a=function(){},f={a:a};new d.Tracker(c,f);b.ok("function"==typeof f.a);f.a=function(){};
b.ok(g.isEqual(c.cset()[0],{obj:f,write:"a",value:null,last:a,lasttx:-1}));b.ok(0===c.readsetSize());b.ok(0===c.newsetSize());b.done()};h.wrapObj=function(b){e();var a={},f=new d.Tracker(c,a),a={a:a};new d.Tracker(c,a);b.ok("object"==typeof a.a);b.ok(g.isEqual(a.a,{}));b.ok(0===c.readsetObject(f.id()));b.ok(1===c.readsetSize());a.a={b:1};b.ok(1===c.readsetSize());b.ok(g.isEqual(c.cset()[0],{obj:a,write:"a",value:{b:1},last:{},lasttx:-1}));f=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(f),
{b:1}));b.ok(1===c.newsetSize());b.ok(g.isEqual(a.a,{b:1}));b.done()};h.wrapArray=function(b){e();var a=[],f=new d.Tracker(c,a),a={a:a};new d.Tracker(c,a);b.ok("object"==typeof a.a);b.ok(g.isEqual(a.a,[]));b.ok(0===c.readsetObject(f.id()));b.ok(1===c.readsetSize());a.a=[1];b.ok(g.isEqual(c.cset()[0],{obj:a,write:"a",value:[1],last:[],lasttx:-1}));f=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(f),[1]));b.ok(1===c.newsetSize());b.ok(g.isEqual(a.a,[1]));b.done()};h.cycleTypes=function(b){e();
var a={a:1};new d.Tracker(c,a);b.ok("number"==typeof a.a);b.ok(1===a.a);b.ok(0===c.readsetSize());a.a="";b.ok(""===a.a);b.ok(0===c.readsetSize());b.ok(g.isEqual(c.cset()[0],{obj:a,write:"a",value:"",last:1,lasttx:-1}));a.a=!0;b.ok(!0===a.a);b.ok(0===c.readsetSize());b.ok(g.isEqual(c.cset()[1],{obj:a,write:"a",value:!0,last:"",lasttx:0}));var f=function(){};a.a=f;b.ok(a.a===f);b.ok(0===c.readsetSize());b.ok(0===c.newsetSize());b.ok(g.isEqual(c.cset()[2],{obj:a,write:"a",value:null,last:!0,lasttx:1}));
a.a={};b.ok(g.isEqual(c.cset()[3],{obj:a,write:"a",value:{},last:f,lasttx:2}));b.ok(0===c.readsetSize());f=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(f),{}));b.ok(1===c.newsetSize());a.a=[];b.ok(g.isEqual(c.cset()[4],{obj:a,write:"a",value:[],last:{},lasttx:3}));b.ok(0===c.readsetSize());f=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(f),[]));b.ok(2===c.newsetSize());b.done()};h.unwrapable=function(b){var a={};Object.defineProperty(a,"a",{enumerable:!0,configurable:!1,value:1});
b.throws(function(){new d.Tracker(c,a)},Error);a=[];Object.defineProperty(a,"a",{enumerable:!0,configurable:!1,value:1});b.throws(function(){new d.Tracker(c,a)},Error);b.done()};h.nonenum=function(b){e();var a={};Object.defineProperty(a,"a",{enumerable:!1,configurable:!0,value:1});b.ok("object"===typeof new d.Tracker(c,a));b.ok(1===a.a);b.ok(0===a._tracker.tc().cset().length);e();a=[];Object.defineProperty(a,"a",{enumerable:!1,configurable:!0,value:1});b.ok("object"===typeof new d.Tracker(c,a));b.ok(1===
a.a);b.ok(0===a._tracker.tc().cset().length);b.done()};h.deleteable=function(b){var a={a:1};b.ok("object"===typeof new d.Tracker(c,a));b.ok(1===a.a);delete a.a;b.ok(void 0===a.a);a=[1];b.ok("object"===typeof new d.Tracker(c,a));b.ok(1===a[0]);delete a[0];b.ok(void 0===a[0]);b.done()};h.arrreverse=function(b){e();var a=[1,2,3,4];b.ok("object"===typeof new d.Tracker(c,a));a.reverse();b.ok(g.isEqual(c.cset()[0],{obj:a,reverse:!0,lasttx:-1}));b.ok(g.isEqual(a,[4,3,2,1]));e();a=[1,2,3,4];b.ok("object"===
typeof new d.Tracker(c,a));a.reverse();a.reverse();b.ok(g.isEqual(c.cset()[0],{obj:a,reverse:!0,lasttx:-1}));b.ok(g.isEqual(c.cset()[1],{obj:a,reverse:!0,lasttx:0}));b.ok(g.isEqual(a,[1,2,3,4]));b.done()};h.arrsort=function(b){e();var a=[1,2,3,4];b.ok("object"===typeof new d.Tracker(c,a));a.sort();b.ok(g.isEqual(c.cset()[0],{obj:a,sort:!0,lasttx:-1}));b.ok(g.isEqual(a,[1,2,3,4]));e();a=[1,2,3,4];b.ok("object"===typeof new d.Tracker(c,a));a.sort(function(a,b){return b-a});a.sort(function(a,b){return b-
a});b.ok(g.isEqual(c.cset()[0],{obj:a,sort:!0,lasttx:-1}));b.ok(g.isEqual(c.cset()[1],{obj:a,sort:!0,lasttx:0}));b.ok(g.isEqual(a,[4,3,2,1]));b.done()};h.arrshift=function(b){e();var a=[1,2];b.ok("object"===typeof new d.Tracker(c,a));a.shift();b.ok(g.isEqual(c.cset()[0],{obj:a,shift:0,size:1,lasttx:-1}));a.unshift(3);b.ok(g.isEqual(c.cset()[1],{obj:a,unshift:0,size:1,lasttx:0}));b.ok(g.isEqual(c.cset()[2],{obj:a,write:"0",value:3,lasttx:1}));a.unshift(4,5);b.ok(g.isEqual(c.cset()[3],{obj:a,unshift:0,
size:2,lasttx:2}));b.ok(g.isEqual(c.cset()[4],{obj:a,write:"0",value:4,lasttx:3}));b.ok(g.isEqual(c.cset()[5],{obj:a,write:"1",value:5,lasttx:4}));b.ok(a,[4,5,3,1]);b.done()};h.pushNumberProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a=1;c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:1,lasttx:-1}]));e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b=2;c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:2,lasttx:-1}]));b.done()};
h.pushBoolProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a=!0;c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:!0,lasttx:-1}]));e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b=!1;c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:!1,lasttx:-1}]));b.done()};h.pushStringProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a="a";c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:"a",lasttx:-1}]));
e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b="b";c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:"b",lasttx:-1}]));b.done()};h.pushOtherProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a=null;c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:null,lasttx:-1}]));e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b=void 0;c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:void 0,lasttx:-1}]));b.done()};
h.pushObjectProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a={};c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:{},lasttx:-1}]));a=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(a),{}));b.ok(1===c.newsetSize());b.ok(0===c.readsetSize());e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b={};c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:{},lasttx:-1}]));a=c.valueId(a.b).toString();b.ok(g.isEqual(c.newsetObject(a),{}));
b.ok(1===c.newsetSize());b.ok(0===c.readsetSize());b.done()};h.pushRecuObjectProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a={b:{}};c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:{b:{}},lasttx:-1}]));var f=c.valueId(a.a.b).toString();b.ok(g.isEqual(c.newsetObject(f),{}));a=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(a),{b:{}}));b.ok(0===c.readsetSize());e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b={c:{}};c.collectObject(a);
b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:{c:{}},lasttx:-1}]));f=c.valueId(a.b.c).toString();b.ok(g.isEqual(c.newsetObject(f),{}));a=c.valueId(a.b).toString();b.ok(g.isEqual(c.newsetObject(a),{c:{}}));b.ok(0===c.readsetSize());b.done()};h.pushArrayProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a=[];c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:[],lasttx:-1}]));a=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(a),[]));b.ok(1===c.newsetSize());
b.ok(0===c.readsetSize());e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b=[];c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:[],lasttx:-1}]));a=c.valueId(a.b).toString();b.ok(g.isEqual(c.newsetObject(a),[]));b.ok(1===c.newsetSize());b.ok(0===c.readsetSize());b.done()};h.pushRecuArrayProp=function(b){e();var a={};b.ok("object"===typeof new d.Tracker(c,a));a.a=[[]];c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"a",value:[[]],lasttx:-1}]));var f=c.valueId(a.a[0]).toString();
b.ok(g.isEqual(c.newsetObject(f),[]));a=c.valueId(a.a).toString();b.ok(g.isEqual(c.newsetObject(a),[[]]));b.ok(0===c.readsetSize());e();a={a:1};b.ok("object"===typeof new d.Tracker(c,a));a.b=[[]];c.collectObject(a);b.ok(g.isEqual(c.cset(),[{obj:a,write:"b",value:[[]],lasttx:-1}]));f=c.valueId(a.b[0]).toString();b.ok(g.isEqual(c.newsetObject(f),[]));a=c.valueId(a.b).toString();b.ok(g.isEqual(c.newsetObject(a),[[]]));b.ok(0===c.readsetSize());b.done()};h.readsetArray=function(b){e();var a=[1,!0,"",
null,void 0];b.ok("object"===typeof new d.Tracker(c,a));a[0];a[1];a[2];a[3];a[4];c.collectObject(a);b.ok(0===c.newsetSize());b.ok(0===c.readsetSize());e();var f={};b.ok("object"===typeof new d.Tracker(c,f));a=[f];b.ok("object"===typeof new d.Tracker(c,a));a[0];c.collectObject(a);b.ok(0===c.newsetSize());b.ok(1===c.readsetSize());b.ok(0===c.readsetObject(f._tracker._id));e();f=[];b.ok("object"===typeof new d.Tracker(c,f));a=[f];b.ok("object"===typeof new d.Tracker(c,a));a[0];c.collectObject(a);b.ok(0===
c.newsetSize());b.ok(1===c.readsetSize());b.ok(0===c.readsetObject(f._tracker._id));b.done()};h.readsetObject=function(b){e();var a={a:1,b:!0,c:"",d:null,e:void 0};b.ok("object"===typeof new d.Tracker(c,a));a.a;a.b;a.c;a.d;a.e;c.collectObject(a);b.ok(0===c.newsetSize());b.ok(0===c.readsetSize());e();var f={};b.ok("object"===typeof new d.Tracker(c,f));a={a:f};b.ok("object"===typeof new d.Tracker(c,a));a.a;c.collectObject(a);b.ok(0===c.newsetSize());b.ok(1===c.readsetSize());b.ok(0===c.readsetObject(f._tracker._id));
e();f=[];b.ok("object"===typeof new d.Tracker(c,f));a={a:f};b.ok("object"===typeof new d.Tracker(c,a));a.a;c.collectObject(a);b.ok(0===c.newsetSize());b.ok(1===c.readsetSize());b.ok(0===c.readsetObject(f._tracker._id));b.done()};h.writesetArray1=function(b){e();var a=[1,!0,"",null,void 0];b.ok("object"===typeof new d.Tracker(c,a));a[0]=2;a[1]=!1;a[2]="a";a[3]=void 0;a[4]=null;c.collectObject(a);var f=[{obj:a,write:"0",value:2,last:1,lasttx:-1},{obj:a,write:"1",value:!1,last:!0,lasttx:0},{obj:a,write:"2",
value:"a",last:"",lasttx:1},{obj:a,write:"3",value:void 0,last:null,lasttx:2},{obj:a,write:"4",value:null,last:void 0,lasttx:3}];b.ok(g.isEqual(c.cset(),f));b.ok(0===c.newsetSize());b.ok(0===c.readsetSize());e();f={};a=[null];b.ok("object"===typeof new d.Tracker(c,a));a[0]=f;c.collectObject(a);f=[{obj:a,write:"0",value:{},last:null,lasttx:-1}];b.ok(g.isEqual(c.cset(),f));a=c.valueId(a[0]).toString();b.ok(g.isEqual(c.newsetObject(a),{}));b.ok(1===c.newsetSize());b.ok(0===c.readsetSize());e();f=[];
a=[null];b.ok("object"===typeof new d.Tracker(c,a));a[0]=f;c.collectObject(a);f=[{obj:a,write:"0",value:[],last:null,lasttx:-1}];b.ok(g.isEqual(c.cset(),f));a=c.valueId(a[0]).toString();b.ok(g.isEqual(c.newsetObject(a),[]));b.ok(1===c.newsetSize());b.ok(0===c.readsetSize());b.done()};h.writesetArray2=function(b){e();var a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.shift();a.shift();a.unshift(5,4);c.collectObject(a);a=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,shift:0,size:1,lasttx:0},{obj:a,
unshift:0,size:2,lasttx:1},{obj:a,write:"0",value:5,lasttx:2},{obj:a,write:"1",value:4,lasttx:3}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.pop();a.pop();a.push(4,5);c.collectObject(a);a=[{obj:a,write:"1",value:4,lasttx:-1},{obj:a,write:"2",value:5,lasttx:0}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.shift();a.pop();a.push(4);a.unshift(0);c.collectObject(a);a=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,unshift:0,
size:1,lasttx:0},{obj:a,write:"0",value:0,lasttx:1},{obj:a,write:"2",value:4,lasttx:2}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.pop();a.shift();a.unshift(0);a.push(4);c.collectObject(a);a=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,unshift:0,size:1,lasttx:0},{obj:a,write:"0",value:0,lasttx:1},{obj:a,write:"2",value:4,lasttx:2}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.pop();a.pop();a.shift();a.unshift(0);a.push(4);
c.collectObject(a);a=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,unshift:0,size:1,lasttx:0},{obj:a,write:"0",value:0,lasttx:1},{obj:a,shift:-1,size:1,lasttx:2},{obj:a,write:"1",value:4,lasttx:3}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.pop();a.shift();a.shift();a.unshift(0);a.push(4);c.collectObject(a);a=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,shift:0,size:1,lasttx:0},{obj:a,unshift:0,size:1,lasttx:1},{obj:a,write:"0",value:0,lasttx:2},{obj:a,write:"1",
value:4,lasttx:3}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.pop();a.pop();a.pop();a.pop();a.unshift(4);c.collectObject(a);a=[{obj:a,unshift:0,size:1,lasttx:-1},{obj:a,write:"0",value:4,lasttx:0},{obj:a,shift:-1,size:3,lasttx:1}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));a.shift();a.shift();a.shift();a.push(4);c.collectObject(a);a=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,shift:0,size:1,lasttx:0},{obj:a,shift:0,
size:1,lasttx:1},{obj:a,write:"0",value:4,lasttx:2}];b.ok(g.isEqual(c.cset(),a));b.done()};h.delObject=function(b){e();var a={a:1,b:2,c:3};b.ok("object"===typeof new d.Tracker(c,a));delete a.b;c.collectObject(a);a=[{obj:a,del:"b",lasttx:-1}];b.ok(g.isEqual(c.cset(),a));e();a={a:1,b:2,c:3};b.ok("object"===typeof new d.Tracker(c,a));delete a.a;delete a.b;delete a.b;delete a.c;c.collectObject(a);a=[{obj:a,del:"a",lasttx:-1},{obj:a,del:"b",lasttx:0},{obj:a,del:"c",lasttx:1}];b.ok(g.isEqual(c.cset(),a));
e();a={a:1,b:2,c:3};b.ok("object"===typeof new d.Tracker(c,a));delete a.b;a.b=1;a.b=4;c.collectObject(a);a=[{obj:a,del:"b",lasttx:-1},{obj:a,write:"b",value:4,lasttx:0}];b.ok(g.isEqual(c.cset(),a));b.done()};h.delArray=function(b){e();var a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));delete a[1];c.collectObject(a);a=[{obj:a,del:"1",lasttx:-1}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));delete a[0];delete a[1];delete a[1];delete a[2];c.collectObject(a);
a=[{obj:a,del:"0",lasttx:-1},{obj:a,del:"1",lasttx:0},{obj:a,del:"2",lasttx:1}];b.ok(g.isEqual(c.cset(),a));e();a=[1,2,3];b.ok("object"===typeof new d.Tracker(c,a));delete a[1];delete a[5];a[1]=1;a[1]=4;c.collectObject(a);a=[{obj:a,write:"1",value:4,lasttx:-1}];b.ok(g.isEqual(c.cset(),a));b.done()};h.reverse=function(b){e();var a=[1,2,3,4];b.ok("object"===typeof new d.Tracker(c,a));a.reverse();c.collectObject(a);var f=[{obj:a,reverse:!0,lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,
3,2,1]));e();a=[1,2,3,4];b.ok("object"===typeof new d.Tracker(c,a));a.reverse();a.reverse();c.collectObject(a);f=[{obj:a,reverse:!0,lasttx:-1},{obj:a,reverse:!0,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[1,2,3,4]));e();a=[1,2,3,4];b.ok("object"===typeof new d.Tracker(c,a));delete a[1];a[1]=2;a.reverse();c.collectObject(a);f=[{obj:a,reverse:!0,lasttx:-1},{obj:a,write:"2",value:2,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,3,2,1]));b.done()};h.sort=function(b){e();var a=
[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.sort();c.collectObject(a);var f=[null,{obj:a,reinit:'["0":1,"1":2,"2":3,"3":4]',lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[1,2,3,4]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.reverse();a.sort();c.collectObject(a);f=[null,null,{obj:a,reinit:'["0":1,"1":2,"2":3,"3":4]',lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[1,2,3,4]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a[1]=2;a.sort();
c.collectObject(a);f=[null,null,{obj:a,reinit:'["0":1,"1":2,"2":3,"3":4]',lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[1,2,3,4]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.sort();delete a[1];a[1]=2;a.reverse();c.collectObject(a);a=[null,null,{obj:a,reinit:'["0":4,"1":3,"2":2,"3":1]',lasttx:-1}];b.ok(g.isEqual(c.cset(),a));b.done()};h.xstore=function(b){e();var a=new shared.store.MongoStore,f={};b.ok("object"===typeof new d.Tracker(a,f));b.throws(function(){c.valueId(f)});
b.done()};h.spliceDel=function(b){e();var a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2);c.collectObject(a);var f=[{obj:a,shift:1,size:2,lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(2);c.collectObject(a);f=[{obj:a,shift:2,size:2,lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,2]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(2,0);c.collectObject(a);b.ok(g.isEqual(c.cset(),
[]));b.ok(g.isEqual(a,[4,2,3,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(-2,1);c.collectObject(a);f=[{obj:a,shift:2,size:1,lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,2,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2);a.push(5);c.collectObject(a);f=[{obj:a,shift:1,size:2,lasttx:-1},{obj:a,write:"2",value:5,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,1,5]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,
a));a.splice(1,2);a.pop();c.collectObject(a);f=[{obj:a,shift:1,size:2,lasttx:-1},{obj:a,shift:-1,size:1,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2);a.shift();c.collectObject(a);f=[{obj:a,shift:1,size:2,lasttx:-1},{obj:a,shift:0,size:1,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2);a.unshift(5);c.collectObject(a);f=[{obj:a,
shift:1,size:2,lasttx:-1},{obj:a,unshift:0,size:1,lasttx:0},{obj:a,write:"0",value:5,lasttx:1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[5,4,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2);delete a[0];c.collectObject(a);f=[{obj:a,shift:1,size:2,lasttx:-1},{obj:a,del:"0",lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2);a[0]=5;c.collectObject(a);f=[{obj:a,shift:1,size:2,lasttx:-1},
{obj:a,write:"0",value:5,last:4,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[5,1]));b.done()};h.spliceIns=function(b){e();var a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,0);c.collectObject(a);b.ok(g.isEqual(c.cset(),[]));b.ok(g.isEqual(a,[4,2,3,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,0,5);c.collectObject(a);var f=[{obj:a,unshift:1,size:1,lasttx:-1},{obj:a,write:"1",value:5,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,
[4,5,2,3,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,0,5,6);c.collectObject(a);f=[{obj:a,unshift:1,size:2,lasttx:-1},{obj:a,write:"1",value:5,lasttx:0},{obj:a,write:"2",value:6,lasttx:1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,5,6,2,3,1]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(4,0,5,6);c.collectObject(a);f=[{obj:a,unshift:4,size:2,lasttx:-1},{obj:a,write:"4",value:5,lasttx:0},{obj:a,write:"5",value:6,lasttx:1}];b.ok(g.isEqual(c.cset(),
f));b.ok(g.isEqual(a,[4,2,3,1,5,6]));e();a=[4,2,3,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(0,0,5,6);c.collectObject(a);f=[{obj:a,unshift:0,size:2,lasttx:-1},{obj:a,write:"0",value:5,lasttx:0},{obj:a,write:"1",value:6,lasttx:1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[5,6,4,2,3,1]));b.done()};h.sparseArray=function(b){e();var a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a[2]=5;c.collectObject(a);var f=[{obj:a,write:"2",value:5,lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,
[4,,5,1]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a[1]=5;delete a[3];c.collectObject(a);f=[{obj:a,del:"3",lasttx:-1},{obj:a,write:"1",value:5,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,5,void 0,void 0]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a[1]=5;a.push(6);c.collectObject(a);f=[{obj:a,write:"1",value:5,lasttx:-1},{obj:a,write:"4",value:6,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,5,void 0,1,6]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,
a));a.pop();a[1]=5;c.collectObject(a);f=[{obj:a,shift:-1,size:1,lasttx:-1},{obj:a,write:"1",value:5,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,5,void 0]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.shift();a[1]=5;c.collectObject(a);f=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,write:"1",value:5,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[void 0,5,1]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.unshift(6);a[1]=5;c.collectObject(a);f=[{obj:a,
unshift:0,size:1,lasttx:-1},{obj:a,write:"0",value:6,lasttx:0},{obj:a,write:"1",value:5,last:4,lasttx:1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[6,5,void 0,void 0,1]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.unshift(6,7);a[1]=5;c.collectObject(a);f=[{obj:a,unshift:0,size:2,lasttx:-1},{obj:a,write:"0",value:6,lasttx:0},{obj:a,write:"1",value:7,lasttx:1},{obj:a,write:"1",value:5,last:7,lasttx:2}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[6,5,4,void 0,void 0,1]));e();a=
[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.reverse();a[1]=5;c.collectObject(a);f=[{obj:a,reverse:!0,lasttx:-1},{obj:a,write:"1",value:5,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[1,5,void 0,4]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.sort();a[1]=5;c.collectObject(a);f=[null,{obj:a,reinit:'["0":1,"1":5,"3":4]',lasttx:-1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[1,5,void 0,4]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2);a[1]=
5;c.collectObject(a);f=[{obj:a,shift:1,size:2,lasttx:-1},{obj:a,write:"1",value:5,last:1,lasttx:0}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,5]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,2,6);a[1]=5;c.collectObject(a);f=[{obj:a,shift:1,size:2,lasttx:-1},{obj:a,unshift:1,size:1,lasttx:0},{obj:a,write:"1",value:5,lasttx:1}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[4,5,1]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.splice(1,1,6);a.unshift(7);c.collectObject(a);
f=[{obj:a,shift:1,size:1,lasttx:-1},{obj:a,unshift:1,size:1,lasttx:0},{obj:a,unshift:0,size:1,lasttx:1},{obj:a,write:"0",value:7,lasttx:2},{obj:a,write:"2",value:6,lasttx:3}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[7,4,6,void 0,1]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.unshift(6);a.splice(1,1,7);a.shift();c.collectObject(a);f=[{obj:a,unshift:0,size:1,lasttx:-1},{obj:a,write:"0",value:6,lasttx:0},{obj:a,shift:1,size:1,lasttx:1},{obj:a,unshift:1,size:1,lasttx:2},{obj:a,shift:0,
size:1,lasttx:3},{obj:a,write:"0",value:7,lasttx:4}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[7,void 0,void 0,1]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.shift();a.splice(1,1,7);a.unshift(6);c.collectObject(a);f=[{obj:a,shift:0,size:1,lasttx:-1},{obj:a,shift:1,size:1,lasttx:0},{obj:a,unshift:1,size:1,lasttx:1},{obj:a,unshift:0,size:1,lasttx:2},{obj:a,write:"0",value:6,lasttx:3},{obj:a,write:"2",value:7,lasttx:4}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[6,void 0,7,1]));
e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));delete a[3];a.splice(1,1,7);a.unshift(6);c.collectObject(a);f=[{obj:a,shift:1,size:1,lasttx:-1},{obj:a,unshift:1,size:1,lasttx:0},{obj:a,unshift:0,size:1,lasttx:1},{obj:a,write:"0",value:6,lasttx:2},{obj:a,write:"2",value:7,lasttx:3},{obj:a,del:"4",lasttx:4}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[6,4,7,void 0,void 0]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));delete a[3];a.splice(1,1,7);a.reverse();a.unshift(6);c.collectObject(a);
f=[{obj:a,shift:1,size:1,lasttx:-1},{obj:a,unshift:1,size:1,lasttx:0},{obj:a,reverse:!0,lasttx:1},{obj:a,unshift:0,size:1,lasttx:2},{obj:a,write:"0",value:6,lasttx:3},{obj:a,del:"1",lasttx:4},{obj:a,del:"2",lasttx:5},{obj:a,write:"3",value:7,lasttx:6}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[6,void 0,void 0,7,4]));e();a=[4,,,1];b.ok("object"===typeof new d.Tracker(c,a));a.push(8);delete a[3];a.splice(1,1,7);a.reverse();a.pop();a.unshift(6);c.collectObject(a);f=[{obj:a,shift:1,size:1,lasttx:-1},
{obj:a,unshift:1,size:1,lasttx:0},{obj:a,reverse:!0,lasttx:1},{obj:a,unshift:0,size:1,lasttx:2},{obj:a,write:"0",value:6,lasttx:3},{obj:a,write:"1",value:8,lasttx:4},{obj:a,del:"2",lasttx:5},{obj:a,write:"4",value:7,lasttx:6}];b.ok(g.isEqual(c.cset(),f));b.ok(g.isEqual(a,[6,8,void 0,void 0,7]));b.done()}})(testtracker||(testtracker={}));var testutils;
(function(h){var e=shared.utils,g=function(){this._lines=[]};g.prototype.write=function(c){this._lines.push(c)};g.prototype.lines=function(){return this._lines.length};g.prototype.line=function(c){return this._lines[c]};var d=/^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3}Z $/;h.clog_empty=function(c){var b=new g;new e.Logger(b,"test",e.LogLevel.INFO,["foo"]);c.ok(0===b.lines());c.done()};h.clog_debug_one_subject=function(c){var b=new g,a=new e.Logger(b,"test",e.LogLevel.INFO,["foo"]);
a.debug("foo","Hello %s","foo");a.debug("bar","Hello %s","bar");a.info("Hello %s","bar");c.ok(2===b.lines());a=b.line(0);c.ok(d.test(a.substr(0,25)));c.ok(e.isEqual(a.substr(25),"test INFO foo: Hello foo\n"));a=b.line(1);c.ok(d.test(a.substr(0,25)));c.ok(e.isEqual(a.substr(25),"test INFO Hello bar\n"));c.done()};h.clog_debug_two_subject=function(c){var b=new g,a=new e.Logger(b,"test",e.LogLevel.INFO,["foo","bar"]);a.debug("foo","Hello %s","foo");a.debug("bar","Hello %s","bar");a.debug("bob","Hello %s",
"bob");c.ok(2===b.lines());a=b.line(0);c.ok(d.test(a.substr(0,25)));c.ok(e.isEqual(a.substr(25),"test INFO foo: Hello foo\n"));a=b.line(1);c.ok(d.test(a.substr(0,25)));c.ok(e.isEqual(a.substr(25),"test INFO bar: Hello bar\n"));c.done()};h.clog_no_debug=function(c){var b=new g,a=new e.Logger(b,"test",e.LogLevel.WARN,["foo","bar"]);a.debug("foo","Hello %s","foo");a.debug("bar","Hello %s","bar");a.debug("bob","Hello %s","bob");a.info("Hello %s","bob");c.ok(0===b.lines());c.done()};h.clog_warn=function(c){var b=
new g,a=new e.Logger(b,"test",e.LogLevel.WARN,[]);a.warn("Hello %s","foo");a.warn("Hello %s","bar");c.ok(2===b.lines());a=b.line(0);c.ok(d.test(a.substr(0,25)));c.ok(e.isEqual(a.substr(25),"test WARNING Hello foo\n"));a=b.line(1);c.ok(d.test(a.substr(0,25)));c.ok(e.isEqual(a.substr(25),"test WARNING Hello bar\n"));c.done()};h.clog_fatal=function(c){var b=new g,a=new e.Logger(b,"test",e.LogLevel.INFO,[]);c.throws(function(){a.fatal("Hello %s","bob")},Error);c.ok(1===b.lines());b=b.line(0);c.ok(d.test(b.substr(0,
25)));c.ok(e.isEqual(b.substr(25),"test FATAL Hello bob\n"));c.done()};h.hashString=function(c){c.throws(function(){e.hash(null)});c.throws(function(){e.hash(void 0)});c.ok(5381===e.hash(""));c.ok(5381===e.hash("",null));c.ok(5381===e.hash("",void 0));c.ok(0===e.hash("",0));c.ok(1==e.hash("",1));c.ok(97==e.hash("a",0));c.ok(3104==e.hash("aa",0));c.ok(3105==e.hash("ab",0));c.ok(166908==e.hash("a"));c.ok(5174245==e.hash("aa"));c.ok(5174246==e.hash("ab"));c.done()};h.isvalue=function(c){c.ok(!e.isValue(null));
c.ok(!e.isValue(void 0));c.ok(e.isValue(0));c.ok(e.isValue(1));c.ok(e.isValue(""));c.ok(e.isValue("a"));c.ok(e.isValue(!0));c.ok(e.isValue(!1));c.ok(e.isValue([]));c.ok(e.isValue([1]));c.ok(e.isValue({}));c.ok(e.isValue({a:1}));c.done()};h.isobject=function(c){c.ok(!e.isObject(null));c.ok(!e.isObject(void 0));c.ok(!e.isObject(0));c.ok(!e.isObject(1));c.ok(!e.isObject(""));c.ok(!e.isObject("a"));c.ok(!e.isObject(!0));c.ok(!e.isObject(!1));c.ok(!e.isObject([]));c.ok(!e.isObject([1]));c.ok(e.isObject({}));
c.ok(e.isObject({a:1}));c.done()};h.typetest=function(c){c.ok("null"===e.typeOf(null));c.ok("undefined"===e.typeOf(void 0));c.ok("number"===e.typeOf(0));c.ok("number"===e.typeOf(1));c.ok("string"===e.typeOf(""));c.ok("string"===e.typeOf("a"));c.ok("boolean"===e.typeOf(!0));c.ok("boolean"===e.typeOf(!1));c.ok("array"===e.typeOf([]));c.ok("array"===e.typeOf([1]));c.ok("object"===e.typeOf({}));c.ok("object"===e.typeOf({a:1}));c.done()};h.unique=function(c){var b=new e.UniqueObject;c.ok(e.isValue(b.id()));
c.ok(b.id()==b.id());c.ok(e.isUID(b.id()));c.ok(!e.isUID(null));c.ok(!e.isUID(""));c.ok(!e.isUID("a"));c.ok(e.isUID(e.makeUID("123456781234567812345678")));c.throws(function(){e.isUID(e.makeUID("23456781234567812345678"))});c.throws(function(){e.isUID(e.makeUID("1123456781234567812345678"))});c.ok(e.isUID(e.makeUID("ABCDEF78ABCDEF78ABCDEF78")));c.throws(function(){e.isUID(e.makeUID("ABCDEFG7ABCDEFG7ABCDEFG7"))});var a=new e.UniqueObject;c.ok(a.id()===a.id());c.ok(e.isUID(a.id()));c.ok(a!==b);var f=
new e.UniqueObject;c.ok(f.id()===f.id());c.ok(e.isUID(f.id()));c.ok(f!==b);c.ok(f!==a);c.done()};h.stringmap=function(c){var b=new e.Map(e.hash);c.ok(!0===b.insert("a","foo"));c.ok(!0===b.insert("b","bar"));c.ok(!1===b.insert("b","bar"));c.ok("foo"===b.find("a"));c.ok("bar"===b.find("b"));c.ok(null===b.find("c"));c.ok(!0===b.remove("a"));c.ok(null===b.find("a"));c.ok(!1===b.remove("a"));c.ok(null===b.find("a"));c.ok("bar"===b.find("b"));c.ok(null===b.find("c"));c.throws(function(){b.insert("c",null)},
Error);c.ok(!1===b.insert("b","new"));c.ok("bar"===b.find("b"));c.done()};h.stringset=function(c){var b=new e.StringSet(["a","b"]);c.throws(function(){b.put(null)},Error);c.throws(function(){b.remove(null)},Error);c.throws(function(){b.id(null)},Error);c.throws(function(){b.has(null)},Error);c.ok(!0===b.has("a"));c.ok(!0===b.has("b"));c.ok(!1===b.has("c"));c.ok(0===b.id("a"));c.ok(1===b.id("b"));c.ok(null===b.id("c"));c.ok(b.id("a")!==b.id("b"));c.ok(!0===b.remove("a"));c.ok(!1===b.remove("a"));c.ok(!1===
b.remove("c"));c.throws(function(){b.put(null)},Error);c.throws(function(){b.remove(null)},Error);c.ok(!0===b.put("a"));c.ok(!1===b.put("a"));c.ok(2===b.id("a"));c.ok(1===b.id("b"));c.ok(null===b.id("c"));c.done()};h.mapapply=function(c){c.expect(5);var b=new e.Map(e.hash);b.apply(function(){c.ok(!1);return!0});c.ok(!0===b.insert("a","foo"));b.apply(function(a,b){c.ok("a"==a&&"foo"==b);return!0});c.ok(!0===b.insert("b","bar"));b.apply(function(a,b){c.ok("a"==a&&"foo"==b||"b"==a&&"bar"==b);return!0});
c.done()}})(testutils||(testutils={}));var testtypes;
(function(h){var e=shared.utils,g=shared.types.TypeStore.instance();h.equality=function(d){d.ok(e.isEqual(g.type({}),g.type({})));d.ok(!e.isEqual(g.type({a:1}),g.type({})));d.ok(e.isEqual(g.type({a:1}),g.type({a:1})));d.ok(e.isEqual(g.type({a:1}),g.type({a:2})));d.ok(e.isEqual(g.type({a:1,b:2}),g.type({a:1,b:2})));d.ok(e.isEqual(g.type({a:1,b:2}),g.type({a:2,b:1})));d.ok(!e.isEqual(g.type({a:1,b:2}),g.type({a:2})));d.ok(e.isEqual(g.type([]),g.type([])));d.ok(!e.isEqual(g.type([1]),g.type([])));d.ok(e.isEqual(g.type([1]),
g.type([1])));d.ok(e.isEqual(g.type([1]),g.type([2])));d.ok(e.isEqual(g.type([1,2]),g.type([1,2])));d.ok(e.isEqual(g.type([1,2]),g.type([2,1])));d.ok(!e.isEqual(g.type([1,2]),g.type([2])));d.ok(!e.isEqual(g.type({}),g.type([])));d.ok(!e.isEqual(g.type({a:1}),g.type([1])));d.ok(!e.isEqual(g.type({a:1,b:1}),g.type([1,2])));d.done()};h.directequality=function(d){d.ok(g.type({})===g.type({}));d.ok(g.type({a:1})!==g.type({}));d.ok(g.type({a:1})===g.type({a:1}));d.ok(g.type({a:1})===g.type({a:2}));d.ok(g.type({a:1,
b:2})===g.type({a:1,b:2}));d.ok(g.type({a:1,b:2})===g.type({a:2,b:1}));d.ok(g.type({a:1,b:2})!==g.type({a:2}));d.ok(g.type([])===g.type([]));d.ok(g.type([1])!==g.type([]));d.ok(g.type([1])===g.type([1]));d.ok(g.type([1])===g.type([2]));d.ok(g.type([1,2])===g.type([1,2]));d.ok(g.type([1,2])===g.type([2,1]));d.ok(g.type([1,2])!==g.type([2]));d.done()};h.isobjarray=function(d){d.ok(g.type({}).isobj());d.ok(!g.type([]).isobj());d.ok(g.type({a:1}).isobj());d.ok(!g.type([1]).isobj());d.ok(g.type({a:1,b:2}).isobj());
d.ok(!g.type([1,2]).isobj());d.ok(!g.type({}).isarray());d.ok(g.type([]).isarray());d.ok(!g.type({a:1}).isarray());d.ok(g.type([1]).isarray());d.ok(!g.type({a:1,b:2}).isarray());d.ok(g.type([1,2]).isarray());d.done()};h.props=function(d){d.ok(e.isEqual(g.type({}).props(),[]));d.ok(e.isEqual(g.type({a:1}).props(),["a"]));d.ok(e.isEqual(g.type({a:1,b:2}).props(),["a","b"]));d.ok(e.isEqual(g.type({a:1,b:2,c:3}).props(),["a","b","c"]));d.ok(e.isEqual(g.type([]).props(),[]));d.ok(e.isEqual(g.type([1]).props(),
["0"]));d.ok(e.isEqual(g.type([1,3]).props(),["0","1"]));d.ok(e.isEqual(g.type([1,3,5]).props(),["0","1","2"]));var c=[,,1];c[7]=2;d.ok(e.isEqual(g.type(c).props(),["2","7"]));d.done()}})(testtypes||(testtypes={}));var testserial;
(function(h){function e(a){return/<[0-9a-fA-F]{24}/.test(a)}function g(b){b.throws(function(){d.writeValue(null,null)});b.ok("null"===d.writeValue(a,null));b.ok("undefined"===d.writeValue(a,void 0));b.ok("0"===d.writeValue(a,0));b.ok("1"===d.writeValue(a,1));b.ok("-1"===d.writeValue(a,-1));b.ok("0"===d.writeValue(a,-0));b.ok("NaN"===d.writeValue(a,NaN));b.ok("Infinity"===d.writeValue(a,Infinity));b.ok("-Infinity"===d.writeValue(a,-Infinity));b.ok("0"===d.writeValue(a,new Number(0)));b.ok("1"===d.writeValue(a,
new Number(1)));b.ok("-1"===d.writeValue(a,new Number(-1)));b.ok("0"===d.writeValue(a,new Number(-0)));b.ok("NaN"===d.writeValue(a,new Number(NaN)));b.ok("Infinity"===d.writeValue(a,new Number(Infinity)));b.ok("-Infinity"===d.writeValue(a,new Number(-Infinity)));b.ok("0"===d.writeValue(a,Number(0)));b.ok("1"===d.writeValue(a,Number(1)));b.ok("-1"===d.writeValue(a,Number(-1)));b.ok("0"===d.writeValue(a,Number(-0)));b.ok("NaN"===d.writeValue(a,Number(NaN)));b.ok("Infinity"===d.writeValue(a,Number(Infinity)));
b.ok("-Infinity"===d.writeValue(a,Number(-Infinity)));b.ok("true"===d.writeValue(a,!0));b.ok("false"===d.writeValue(a,!1));b.ok("true"===d.writeValue(a,new Boolean(!0)));b.ok("false"===d.writeValue(a,new Boolean(!1)));b.ok("true"===d.writeValue(a,Boolean(!0)));b.ok("false"===d.writeValue(a,Boolean(!1)));b.ok('""'===d.writeValue(a,""));b.ok('"a"'===d.writeValue(a,"a"));b.ok('"abc"'===d.writeValue(a,"abc"));b.ok('"a\'bc"'===d.writeValue(a,"a'bc"));b.ok('"a\\"bc"'===d.writeValue(a,'a"bc'));b.ok('""'===
d.writeValue(a,new String("")));b.ok('"a"'===d.writeValue(a,new String("a")));b.ok('"abc"'===d.writeValue(a,new String("abc")));b.ok('"a\'bc"'===d.writeValue(a,new String("a'bc")));b.ok('"a\\"bc"'===d.writeValue(a,new String('a"bc')));b.ok('""'===d.writeValue(a,""));b.ok('"a"'===d.writeValue(a,"a"));b.ok('"abc"'===d.writeValue(a,"abc"));b.ok('"a\'bc"'===d.writeValue(a,"a'bc"));b.ok('"a\\"bc"'===d.writeValue(a,'a"bc'));b.ok(0===Date.parse(d.writeValue(a,new Date(0))));b.ok(1E4===Date.parse(d.writeValue(a,
new Date(1E4))));b.ok("null"===d.writeValue(a,function(){}));b.ok("null"===d.writeValue(a,g));b.ok("null"===d.writeValue(a,/a/));b.ok("null"===d.writeValue(a,Error()));b.ok(e(d.writeValue(a,{})));b.ok(e(d.writeValue(a,{a:1})));b.ok(e(d.writeValue(a,{a:1,c:2})));b.ok(e(d.writeValue(a,[])));b.ok(e(d.writeValue(a,[1])));b.ok(e(d.writeValue(a,[1,3])));var c={a:1};b.ok(e(d.writeValue(a,c))===e(d.writeValue(a,c)));var h=[1];b.ok(e(d.writeValue(a,h))===e(d.writeValue(a,h)));b.ok(d.writeValue(a,c)!==d.writeValue(a,
h));b.ok("xxxnull"===d.writeValue(a,null,"xxx"));b.ok("xxxundefined"===d.writeValue(a,void 0,"xxx"));b.ok("xxx0"===d.writeValue(a,0,"xxx"));b.ok('xxx"aaa"'===d.writeValue(a,"aaa","xxx"));b.ok(d.writeValue(a,c,"xxx")==="xxx<"+c._id.toString()+">");b.ok(d.writeValue(a,h,"xxx")==="xxx<"+h._id.toString()+">");b.done()}var d=shared.serial,c=shared.utils,b=function(){};b.prototype.valueId=function(a){void 0===a._id&&Object.defineProperty(a,"_id",{value:shared.utils.UID()});return a._id};b.prototype.valueRev=
function(a){void 0===a._rev&&Object.defineProperty(a,"_rev",{value:0});return a._rev};var a=new b;h.writeValue=g;h.writeObject=function(b){b.throws(function(){d.writeObject(null,null)});b.throws(function(){d.writeObject(null,{})});b.throws(function(){d.writeObject(a,null)});b.ok("{}"===d.writeObject(a,{}));b.ok('{"a":null}'===d.writeObject(a,{a:null}));b.ok('{"a":undefined}'===d.writeObject(a,{a:void 0}));b.ok('{"a":0}'===d.writeObject(a,{a:0}));b.ok('{"a":1}'===d.writeObject(a,{a:1}));b.ok('{"a":-1}'===
d.writeObject(a,{a:-1}));b.ok('{"a":0}'===d.writeObject(a,{a:-0}));b.ok('{"a":NaN}'===d.writeObject(a,{a:NaN}));b.ok('{"a":Infinity}'===d.writeObject(a,{a:Infinity}));b.ok('{"a":-Infinity}'===d.writeObject(a,{a:-Infinity}));b.ok('{"a":true}'===d.writeObject(a,{a:!0}));b.ok('{"a":false}'===d.writeObject(a,{a:!1}));b.ok('{"a":true}'===d.writeObject(a,{a:new Boolean(!0)}));b.ok('{"a":false}'===d.writeObject(a,{a:new Boolean(!1)}));b.ok('{"a":true}'===d.writeObject(a,{a:Boolean(!0)}));b.ok('{"a":false}'===
d.writeObject(a,{a:Boolean(!1)}));b.ok('{"a":""}'===d.writeObject(a,{a:""}));b.ok('{"a":"a"}'===d.writeObject(a,{a:"a"}));b.ok('{"a":"abc"}'===d.writeObject(a,{a:"abc"}));b.ok('{"a":"a\'bc"}'===d.writeObject(a,{a:"a'bc"}));b.ok('{"a":"a\\"bc"}'===d.writeObject(a,{a:'a"bc'}));b.ok('{"a":""}'===d.writeObject(a,{a:new String("")}));b.ok('{"a":"a"}'===d.writeObject(a,{a:new String("a")}));b.ok('{"a":"abc"}'===d.writeObject(a,{a:new String("abc")}));b.ok('{"a":"a\'bc"}'===d.writeObject(a,{a:new String("a'bc")}));
b.ok('{"a":"a\\"bc"}'===d.writeObject(a,{a:new String('a"bc')}));b.ok('{"a":""}'===d.writeObject(a,{a:""}));b.ok('{"a":"a"}'===d.writeObject(a,{a:"a"}));b.ok('{"a":"abc"}'===d.writeObject(a,{a:"abc"}));b.ok('{"a":"a\'bc"}'===d.writeObject(a,{a:"a'bc"}));b.ok('{"a":"a\\"bc"}'===d.writeObject(a,{a:'a"bc'}));b.ok('{"a":null}'===d.writeObject(a,{a:function(){}}));b.ok('{"a":null}'===d.writeObject(a,{a:g}));b.ok('{"a":null}'===d.writeObject(a,{a:/a/}));b.ok('{"a":null}'===d.writeObject(a,{a:Error()}));
b.ok("[]"===d.writeObject(a,[]));b.ok('["0":null]'===d.writeObject(a,[null]));b.ok('["0":undefined]'===d.writeObject(a,[void 0]));b.ok('["0":0]'===d.writeObject(a,[0]));b.ok('["0":1]'===d.writeObject(a,[1]));b.ok('["0":-1]'===d.writeObject(a,[-1]));b.ok('["0":0]'===d.writeObject(a,[-0]));b.ok('["0":NaN]'===d.writeObject(a,[NaN]));b.ok('["0":Infinity]'===d.writeObject(a,[Infinity]));b.ok('["0":-Infinity]'===d.writeObject(a,[-Infinity]));b.ok('["0":true]'===d.writeObject(a,[!0]));b.ok('["0":false]'===
d.writeObject(a,[!1]));b.ok('["0":true]'===d.writeObject(a,[new Boolean(!0)]));b.ok('["0":false]'===d.writeObject(a,[new Boolean(!1)]));b.ok('["0":true]'===d.writeObject(a,[Boolean(!0)]));b.ok('["0":false]'===d.writeObject(a,[Boolean(!1)]));b.ok('["0":""]'===d.writeObject(a,[""]));b.ok('["0":"a"]'===d.writeObject(a,["a"]));b.ok('["0":"abc"]'===d.writeObject(a,["abc"]));b.ok('["0":"a\'bc"]'===d.writeObject(a,["a'bc"]));b.ok('["0":"a\\"bc"]'===d.writeObject(a,['a"bc']));b.ok('["0":""]'===d.writeObject(a,
[new String("")]));b.ok('["0":"a"]'===d.writeObject(a,[new String("a")]));b.ok('["0":"abc"]'===d.writeObject(a,[new String("abc")]));b.ok('["0":"a\'bc"]'===d.writeObject(a,[new String("a'bc")]));b.ok('["0":"a\\"bc"]'===d.writeObject(a,[new String('a"bc')]));b.ok('["0":""]'===d.writeObject(a,[""]));b.ok('["0":"a"]'===d.writeObject(a,["a"]));b.ok('["0":"abc"]'===d.writeObject(a,["abc"]));b.ok('["0":"a\'bc"]'===d.writeObject(a,["a'bc"]));b.ok('["0":"a\\"bc"]'===d.writeObject(a,['a"bc']));b.ok('["0":null]'===
d.writeObject(a,[function(){}]));b.ok('["0":null]'===d.writeObject(a,[g]));b.ok('["0":null]'===d.writeObject(a,[/a/]));b.ok('["0":null]'===d.writeObject(a,[Error()]));var j={a:1},e=[1,3];b.ok(d.writeObject(a,{a:j})=='{"a":<'+j._id.toString()+">}");b.ok(d.writeObject(a,{a:j,b:j})=='{"a":<'+j._id.toString()+'>,"b":<'+j._id.toString()+">}");b.ok(d.writeObject(a,{a:e})=='{"a":<'+e._id.toString()+">}");b.ok(d.writeObject(a,{a:e,b:e})=='{"a":<'+e._id.toString()+'>,"b":<'+e._id.toString()+">}");b.ok(d.writeObject(a,
[j])=='["0":<'+j._id.toString()+">]");b.ok(d.writeObject(a,[j,j])=='["0":<'+j._id.toString()+'>,"1":<'+j._id.toString()+">]");b.ok(d.writeObject(a,[e])=='["0":<'+e._id.toString()+">]");b.ok(d.writeObject(a,[e,e])=='["0":<'+e._id.toString()+'>,"1":<'+e._id.toString()+">]");b.ok(c.isUID(j._id));b.ok(c.isUID(e._id));b.done()};h.writeObjectId=function(b){var c={};delete c._id;delete c._rev;b.ok(d.writeObject(a,c,"",!0)==="{"+c._id+" "+c._rev+" }");b.ok(d.writeObject(a,c,"",!0)==="{"+c._id+" "+c._rev+
" }");c={a:1};delete c._id;delete c._rev;b.ok(d.writeObject(a,c,"",!0)==="{"+c._id+" "+c._rev+' "a":1}');b.ok(d.writeObject(a,c,"",!0)==="{"+c._id+" "+c._rev+' "a":1}');c={a:1,b:"x"};delete c._id;delete c._rev;b.ok(d.writeObject(a,c,"",!0)==="{"+c._id+" "+c._rev+' "a":1,"b":"x"}');b.ok(d.writeObject(a,c,"",!0)==="{"+c._id+" "+c._rev+' "a":1,"b":"x"}');c=[];delete c._id;delete c._rev;b.ok(d.writeObject(a,c,"",!0)==="["+c._id+" "+c._rev+" ]");b.ok(d.writeObject(a,c,"",!0)==="["+c._id+" "+c._rev+" ]");
c=[1];delete c._id;delete c._rev;b.ok(d.writeObject(a,c,"",!0)==="["+c._id+" "+c._rev+' "0":1]');b.ok(d.writeObject(a,c,"",!0)==="["+c._id+" "+c._rev+' "0":1]');c=[1,2];delete c._id;delete c._rev;b.ok(d.writeObject(a,c,"",!0)==="["+c._id+" "+c._rev+' "0":1,"1":2]');b.ok(d.writeObject(a,c,"",!0)==="["+c._id+" "+c._rev+' "0":1,"1":2]');b.done()};h.readValue=function(b){b.throws(function(){d.readValue(null)});b.ok(null===d.readValue("null"));b.ok(void 0===d.readValue("undefined"));b.ok(0===d.readValue("0"));
b.ok(1===d.readValue("1"));b.ok(-1===d.readValue("-1"));b.ok(0===d.readValue("-0"));b.ok(isNaN(d.readValue("NaN")));b.ok(Infinity===d.readValue("Infinity"));b.ok(-Infinity===d.readValue("-Infinity"));b.ok(!0===d.readValue("true"));b.ok(!1===d.readValue("false"));b.ok(""===d.readValue('""'));b.ok("a"===d.readValue('"a"'));b.ok("abc"===d.readValue('"abc"'));b.ok("a'bc"===d.readValue('"a\'bc"'));b.ok('a"bc'===d.readValue('"a\\"bc"'));var e={};delete e._id;b.ok(c.isEqual(d.readValue(d.writeValue(a,e)),
new d.Reference(e._id)));e={a:1};delete e._id;b.ok(c.isEqual(d.readValue(d.writeValue(a,e)),new d.Reference(e._id)));e={a:1,c:2};delete e._id;b.ok(c.isEqual(d.readValue(d.writeValue(a,e)),new d.Reference(e._id)));e=[];delete e._id;b.ok(c.isEqual(d.readValue(d.writeValue(a,e)),new d.Reference(e._id)));e=[1];delete e._id;b.ok(c.isEqual(d.readValue(d.writeValue(a,e)),new d.Reference(e._id)));e=[1,3];delete e._id;b.ok(c.isEqual(d.readValue(d.writeValue(a,e)),new d.Reference(e._id)));b.throws(function(){d.readValue("xxxnull")});
b.ok(null===d.readValue("nullxxx"));b.throws(function(){d.readValue("xxx0")});b.ok(0===d.readValue("0xxx"));b.ok(-1.2033439999999999E22===d.readValue("-120.3344e20xxx"));b.throws(function(){d.readValue("aaa<123456781234567812345678>")});b.ok(c.isEqual(d.readValue("<123456781234567812345678>aaa"),new d.Reference(c.makeUID("123456781234567812345678"))));b.done()};h.readObject=function(a){a.throws(function(){d.readObject("")});a.throws(function(){d.readObject("0")});a.throws(function(){d.readObject("{}",
[])});a.throws(function(){d.readObject("[]",{})});a.ok(c.isEqual(d.readObject("{}"),{}));a.ok(c.isEqual(d.readObject('{"a":1}'),{a:1}));a.ok(c.isEqual(d.readObject('{"a":1,"b":2}'),{a:1,b:2}));a.ok(c.isEqual(d.readObject('{ "a" : 1 , "b" : 2 }'),{a:1,b:2}));a.ok(c.isEqual(d.readObject("[]"),[]));a.ok(c.isEqual(d.readObject('["0":1]'),[1]));a.ok(c.isEqual(d.readObject('["0":1,"1":2]'),[1,2]));a.ok(c.isEqual(d.readObject('[ "0" : 1 , "1" : 2 }'),[1,2]));a.ok(c.isEqual(d.readObject('["2":1]'),[,,1]));
a.ok(c.isEqual(d.readObject('[ "0" : 1 , "2" : 2 }'),[1,,2]));a.ok(c.isEqual(d.readObject("{}",{a:1,b:2}),{a:1,b:2}));a.ok(c.isEqual(d.readObject('{"a":3}',{a:1,b:2}),{a:3,b:2}));a.ok(c.isEqual(d.readObject('{"b":3}',{a:1,b:2}),{b:3}));a.ok(c.isEqual(d.readObject('{"c":3}',{a:1,b:2}),{c:3}));a.ok(c.isEqual(d.readObject("[]",[1,2]),[]));a.ok(c.isEqual(d.readObject('["0":3]',[1,2]),[3]));a.ok(c.isEqual(d.readObject('["1":3]',[1,2]),[,3]));a.ok(c.isEqual(d.readObject('["2":3]',[1,2]),[,,3]));a.done()};
h.scaleNumber=function(b){for(var c=1;;){var e=d.writeValue(a,c),e=d.readValue(e);b.ok(c===e);c*=10;if(Infinity===c)break}b.done()}})(testserial||(testserial={}));var testundo;
(function(h){function e(){null!=c&&c.close();return c=new shared.store.MongoStore}function g(b,a){var c=e();c.apply(function(a){a.a=0},function(e){b.ok(null===e);c.apply(function(b){a(b);throw Error();},function(a){b.ok(null!==a);c.apply(function(a){b.ok(d.isEqual(a,{a:0}));delete a.a},function(a){b.ok(null===a);c.close();b.done()})})})}var d=shared.utils,c=null;h.newProps=function(b){var a=e();a.apply(function(a){a.a=1;a.b=!0;a.c="";a.d=null;a.e=void 0;a.f=new Number(0);a.g=new Date;a.h=function(){};
a.i={};a.j=[];a.k={a:{}};a.l=[[]];a.m={a:[]};a.n=[{}];Object.defineProperty(a,"o",{value:1});throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{}))},function(){a.close();b.done()})})};h.changePropsNumber=function(b){g(b,function(a){a.a=1})};h.changePropsNull=function(b){g(b,function(a){a.a=null})};h.changePropsUndefined=function(b){g(b,function(a){a.a=void 0})};h.changePropsString=function(b){g(b,function(a){a.a="a"})};h.changePropsDate=function(b){g(b,function(a){a.a=
new Date})};h.changePropsFunction=function(b){g(b,function(a){a.a=new function(){}})};h.changePropsObject=function(b){g(b,function(a){a.a={}})};h.changePropsArray=function(b){g(b,function(a){a.a=[]})};h.deleteProp=function(b){var a=e();a.apply(function(a){a.a=1},function(c){b.ok(null===c);a.apply(function(a){delete a.a;throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(1===a.a);delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.deleteNestedProp=function(b){var a=e();
a.apply(function(a){a.a={b:1}},function(c){b.ok(null===c);a.apply(function(a){delete a.a.b;throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(1===a.a.b);delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.deleteNestedProp2=function(b){var a=e();a.apply(function(a){a.a=[1]},function(c){b.ok(null===c);a.apply(function(a){delete a.a[0];throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(1===a.a[0]);delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};
h.newArrayProps=function(b){var a=e();a.apply(function(a){a.a=[]},function(c){b.ok(null===c);a.apply(function(a){a.a[0]=1;throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.changeArrayProps=function(b){var a=e();a.apply(function(a){a.a=[1]},function(c){b.ok(null===c);a.apply(function(a){a.a[0]=2;throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[1]}));delete a.a},
function(c){b.ok(null===c);a.close();b.done()})})})};h.deleteArrayProps=function(b){var a=e();a.apply(function(a){a.a=[1]},function(c){b.ok(null===c);a.apply(function(a){delete a.a[0];throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arrayPush=function(b){var a=e();a.apply(function(a){a.a=[]},function(c){b.ok(null===c);a.apply(function(a){a.a.push(1);throw Error();},function(c){b.ok(null!==c);
a.apply(function(a){b.ok(d.isEqual(a,{a:[]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arrayPop=function(b){var a=e();a.apply(function(a){a.a=[1]},function(c){b.ok(null===c);a.apply(function(a){a.a.pop();throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arrayShift=function(b){var a=e();a.apply(function(a){a.a=[1]},function(c){b.ok(null===c);a.apply(function(a){a.a.shift();
throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arrayUnShift=function(b){var a=e();a.apply(function(a){a.a=[1]},function(c){b.ok(null===c);a.apply(function(a){a.a.unshift(2);throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arraySort=function(b){var a=e();a.apply(function(a){a.a=[2,3,
1]},function(c){b.ok(null===c);a.apply(function(a){a.a.sort();throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[2,3,1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arrayReverse=function(b){var a=e();a.apply(function(a){a.a=[2,3,1]},function(c){b.ok(null===c);a.apply(function(a){a.a.reverse();throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[2,3,1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};
h.arraySplice1=function(b){var a=e();a.apply(function(a){a.a=[2,3,1]},function(c){b.ok(null===c);a.apply(function(a){a.a.splice(1,1);throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[2,3,1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arraySplice2=function(b){var a=e();a.apply(function(a){a.a=[2,3,1]},function(c){b.ok(null===c);a.apply(function(a){a.a.splice(1,0,4);throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,
{a:[2,3,1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})};h.arraySplice3=function(b){var a=e();a.apply(function(a){a.a=[2,3,1]},function(c){b.ok(null===c);a.apply(function(a){a.a.splice(0,3,4);throw Error();},function(c){b.ok(null!==c);a.apply(function(a){b.ok(d.isEqual(a,{a:[2,3,1]}));delete a.a},function(c){b.ok(null===c);a.close();b.done()})})})}})(testundo||(testundo={}));var testcommit;
(function(h){function e(){null!=a&&a.close();return a=new shared.store.MongoStore}function g(a,b,c){var d=e(),g;d.apply(function(a){g=a._tracker._rev;b(a);return a},function(b,e){a.ok(null===b);a.ok(c(e));a.ok(e._tracker._rev===g+1);d.apply(function(a){delete a.a},function(b){a.ok(null===b);d.close();a.done()})})}function d(a,b,c,d){var g=e();g.apply(function(a){b(a);return a},function(b){a.ok(null===b);g.apply(function(a){c(a)},function(b){a.ok(null===b);g.apply(function(a){return d(a)},function(b,
c){a.ok(null===b);a.ok(c);g.close();a.done()})})})}var c=shared.utils,b=shared.store;require("util");var a=null;h.create=function(a){var c=e(),d=b.createStore({}),g=b.createStore({});a.ok(c!==d);a.ok(c!==g);a.ok(d!==g);d.close();g.close();a.done()};h.emptyCommit=function(a){var b=e();b.apply(function(b){a.ok(c.isObject(b))},function(c){a.ok(null===c);b.close();a.done()})};h.simpleAssignNumber=function(a){g(a,function(a){a.a=1},function(a){return 1===a.a})};h.simpleAssignNumber2=function(a){g(a,function(a){a.a=
2},function(a){return 2===a.a})};h.simpleAssignString=function(a){g(a,function(a){a.a="foo"},function(a){return"foo"===a.a})};h.simpleAssignBool=function(a){g(a,function(a){a.a=!0},function(a){return!0===a.a})};h.simpleAssignNull=function(a){g(a,function(a){a.a=null},function(a){return null===a.a})};h.simpleAssignUndefined=function(a){g(a,function(a){a.a=void 0},function(a){return void 0===a.a})};h.simpleAssignObject=function(a){g(a,function(a){a.a={}},function(a){return c.isEqual(a.a,{})})};h.simpleAssignArray=
function(a){g(a,function(a){a.a=[]},function(a){return c.isEqual(a.a,[])})};h.simpleAssignNestedObject=function(a){g(a,function(a){a.a={b:{}}},function(a){return c.isEqual(a.a,{b:{}})})};h.simpleAssignNestedArray=function(a){g(a,function(a){a.a=[[0]]},function(a){return c.isEqual(a.a,[[0]])})};h.assignOverwrite=function(a){d(a,function(a){a.a=1;a.b=2},function(a){a.a=3},function(a){var b=a.a;delete a.a;delete a.b;return 3===b})};h.assignNested=function(a){d(a,function(a){a.a={b:0}},function(a){a.a.b=
1},function(a){var b=a.a.b;delete a.a;return 1===b})};h.assignNested2=function(a){d(a,function(a){a.a={count:1};a.b={count:1}},function(a){a.a.count+=1;a.b.count-=1},function(a){var b=a.a.count,c=a.b.count;delete a.a;delete a.b;return 2===b&&0===c})};h.delProp=function(a){d(a,function(a){a.a=1},function(a){delete a.a},function(a){return void 0===a.a})};h.delNested=function(a){d(a,function(a){a.a={}},function(a){delete a.a},function(a){return void 0===a.a})};h.delDoubleNested=function(a){d(a,function(a){a.a=
{b:{}}},function(a){delete a.a.b},function(a){var b=void 0===a.a.b;delete a.a;return b})};h.arrayDel=function(a){d(a,function(a){a.a=[1,2,3]},function(a){delete a.a[1]},function(a){var b=c.isEqual(a.a,[1,,3]);delete a.a;return b})};h.arraySort=function(a){d(a,function(a){a.a=[4,2,3,1]},function(a){a.a.sort()},function(a){var b=c.isEqual(a.a,[1,2,3,4]);delete a.a;return b})};h.arrayReverse=function(a){d(a,function(a){a.a=[4,2,3,1]},function(a){a.a.reverse()},function(a){var b=c.isEqual(a.a,[1,3,2,
4]);delete a.a;return b})};h.arrayShift1=function(a){d(a,function(a){a.a=[4,2,3,1]},function(a){a.a.shift()},function(a){var b=c.isEqual(a.a,[2,3,1]);delete a.a;return b})};h.arrayShift2=function(a){d(a,function(a){a.a=[4,2,3,1]},function(a){a.a.splice(1,2)},function(a){var b=c.isEqual(a.a,[4,1]);delete a.a;return b})};h.arrayShift3=function(a){d(a,function(a){a.a=[4,2,3,1]},function(a){a.a.splice(3,2)},function(a){var b=c.isEqual(a.a,[4,2,3]);delete a.a;return b})};h.arrayUnShift1=function(a){d(a,
function(a){a.a=[4,2,3,1]},function(a){a.a.unshift(5)},function(a){var b=c.isEqual(a.a,[5,4,2,3,1]);delete a.a;return b})};h.arrayUnShift2=function(a){d(a,function(a){a.a=[4,2,3,1]},function(a){a.a.unshift(5,6)},function(a){var b=c.isEqual(a.a,[5,6,4,2,3,1]);delete a.a;return b})};h.arrayUnShift3=function(a){d(a,function(a){a.a=[4,2,3,1]},function(a){a.a.splice(1,0,5,6)},function(a){var b=c.isEqual(a.a,[4,5,6,2,3,1]);delete a.a;return b})};h.arraySplice=function(a){d(a,function(a){a.a=[4,2,3,1]},
function(a){a.a.splice(1,2,7,8)},function(a){var b=c.isEqual(a.a,[4,7,8,1]);delete a.a;return b})};h.wrappedPush=function(a){d(a,function(a){a.a=[]},function(a){a.a.push(1)},function(a){var b=c.isEqual(a.a,[1]);delete a.a;return b})}})(testcommit||(testcommit={}));exports.utils=testutils;exports.types=testtypes;exports.serial=testserial;exports.tracker=testtracker;exports.undo=testundo;exports.commit=testcommit;
