<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACVIS</title>
    <link rel="stylesheet" href="/luca-app/front/public/styles/actor-profile.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/3.0.7/umd.min.js"></script>
    <style>
        canvas {
            max-width: 100%;
            max-height: 400px;
            width: 100%;
            height: auto;
            margin-top: 30%;
        }

        .chart-container {
            width: 33.33%;
            float: left;
            margin-top: 20px;
            box-sizing: border-box;
            padding: 10px;
        }

         canvas {
             max-width: 100%;
             max-height: 400px;
             width: 100%;
             height: auto;
             margin-top: 30%;
         }

        .chart-container {
            width: 33.33%;
            float: left;
            margin-top: 20px;
            box-sizing: border-box;
            padding: 10px;
        }

        .awards-table-container {
            margin-top: 20px;
        }

        .awards-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 18px;
            text-align: left;
        }

        .awards-table th, .awards-table td {
            border: 1px solid #ddd;
            padding: 12px;
        }

        .awards-table th {
            background-color: #000000;
            color: white;
            text-align: center;
        }

        .awards-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .awards-table tr:hover {
            background-color: #ddd;
        }

        .awards-table td {
            text-align: center;
        }
    </style>
</head>
<body>
<div class="tab">
    <button onclick="location.href='/luca-app/front/home';" class="tabs">Home</button>
    <div class="search-bar">
        <input type="text" placeholder="Search">
    </div>
    <button onclick="openForm()" class="tabs">News</button>
    <button onclick="location.href='/luca-app/front/favorites';" class="tabs">Favorites</button>
    <button class="tabs" id="add" >Add to Favourites</button>
    <button onclick="handleLogout()" class="tabs">Log Out</button>
</div>
<div class="form-container"></div>
<div class="intro-container">
    <div class="actress-name">
        <h1></h1>
    </div>
    <div class="intro-pictures">
        <div class="actor-picture"></div>
        <div class="intro-video"></div>
    </div>
</div>
<div class="Actor-Awards">
    <div class="movie-awards">
        <div class="movie-container">
            <div class="movie-details">
                <div class="year"></div>
                <div class="category"></div>
                <div class="movie-name"></div>
                <div class="Score"></div>
                <div class="movie-picture"></div>
            </div>
        </div>
    </div>
    <div class="all-movies">
        <h1>Movies</h1>
        <div class="movie-container">
            <div class="movie-details">
                <div class="movie-name">
                    <h1></h1>
                </div>
                <div class="movie-picture"></div>
            </div>
        </div>
    </div>
    <div class="related-news">
        <div class="button-container">
            <h1>News</h1>
            <button onclick="redirectToSource('https://variety.com')">Variety</button>
            <button onclick="redirectToSource('https://www.bbc.com/news')">BBC News</button>
            <button onclick="redirectToSource('https://edition.cnn.com')">CNN</button>
            <button onclick="redirectToSource('https://www.nytimes.com')">The New York Times</button>
        </div>
    </div>
    <div class="chart-container">
        <canvas id="genreChart"></canvas>
        <button onclick="exportChartToWebP('genreChart')">Export to WebP</button>
    </div>

    <div class="chart-container" style="margin-top: 10%;">
        <canvas id="awardChart"></canvas>
        <button onclick="exportChartToSVG('awardChart')">Export to SVG</button>
    </div>

    <div class="chart-container" style="margin-top: 10%;">
        <canvas id="popularityYearChart"></canvas>
        <button onclick="exportChartToCSV('popularityYearChart')">Export to CSV</button>
    </div>
</div>
<div class="low-bar">
    <div class="references">
        <label onclick="location.href='/luca-app/front/about';" class="references-element">About</label>
        <label onclick="location.href='/luca-app/front/help';" class="references-element">Help</label>
        <label onclick="location.href='/luca-app/front/index';" class="references-element">Site Index</label>
    </div>
</div>
<script>
    function openForm() {
        const existingForm = document.querySelector('.form-container form');
        if (existingForm) {
            existingForm.remove();
        }

        const form = document.createElement('form');
        form.setAttribute('id', 'myForm');

        const button1 = createButton('Variety', 'https://variety.com');
        form.appendChild(button1);

        const button2 = createButton('BBC News', 'https://www.bbc.com/news');
        form.appendChild(button2);

        const button3 = createButton('CNN', 'https://edition.cnn.com');
        form.appendChild(button3);

        const button4 = createButton('The New York Times', 'https://www.nytimes.com');
        form.appendChild(button4);

        document.querySelector('.form-container').appendChild(form);
    }

    function createButton(text, source) {
        const button = document.createElement('button');
        button.type = 'button';
        button.textContent = text;
        button.addEventListener('click', function(event) {
            event.preventDefault();
            saveSource(source)
                .then(() => redirectActorPage());
        });
        return button;
    }

    function saveSource(source) {
        return new Promise((resolve, reject) => {
            document.cookie = `source=${encodeURIComponent(source)}; expires=${new Date(Date.now() + 86400000).toUTCString()}; path=/`;
            resolve();
        });
    }

    function redirectActorPage() {
        return new Promise((resolve, reject) => {
            const actorName = document.querySelector('.actress-name h1');
            const name = actorName ? actorName.textContent.trim() : '';
            if (!name) {
                console.error("Actor name is missing!");
                reject("Actor name is missing!");
                return;
            }
            window.location.href = `/luca-app/front/news/:${name}`;
            resolve();
        });
    }

    function handleLogout() {
        fetch('/luca-app/main/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'logout-message': 'LogOut'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to log out');
                }
                window.location.href = '/luca-app/front/login';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during logout: ' + error.message);
            });
    }

    const path = window.location.pathname;
    var lastIndex = path.lastIndexOf("/");
    var id = path.substring(lastIndex + 1);
    let formData = new URLSearchParams();
    formData.append('id', id);

    const addToFavoritesBtn = document.getElementById('add');
    addToFavoritesBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/luca-app/main/add-favorites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData,
            });

            if (!response.ok) {
                throw new Error('Failed to add to favourites.');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    fetch('/luca-app/main/actor-profile-info', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData,
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch the JSON data. Status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const movieContainer = document.querySelector('.all-movies .movie-container');
            const actorPicture = document.querySelector('.actor-picture');
            const actorName = document.querySelector('.actress-name h1');
            const profileImg = document.createElement('img');
            actorName.textContent = data.data[0].name;
            profileImg.src = data.data[0].profile_path;
            actorPicture.innerHTML = '';
            actorPicture.appendChild(profileImg);

            data.data.forEach(actor => {
                actor.known_for.forEach(movie => {
                    const movieDetails = document.createElement('div');
                    movieDetails.classList.add('movie-details');

                    const movieName = document.createElement('div');
                    movieName.classList.add('movie-name');
                    movieName.innerHTML = `<h1>${movie.title}</h1>`;

                    const moviePicture = document.createElement('div');
                    moviePicture.classList.add('movie-picture');
                    moviePicture.innerHTML = `<img src="${movie.poster_path}" alt="Poster film">`;

                    movieDetails.appendChild(movieName);
                    movieDetails.appendChild(moviePicture);

                    const score = document.createElement('div');
                    score.classList.add('Score');
                    score.innerHTML = `Score: ${movie.vote_average}`;

                    movieDetails.appendChild(score);

                    movieContainer.appendChild(movieDetails);
                });
            });
            if (data.award) {
                createAwardsTable(data.awards);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });

    function createAwardsTable(awards) {
        const actorAwardsDiv = document.querySelector('.movie-awards');
        const heading = document.createElement('h1');
        heading.textContent = 'Actor Awards';
        actorAwardsDiv.appendChild(heading);
        const awardsTableDiv = document.createElement('div');
        awardsTableDiv.classList.add('awards-table-container');

        const awardsTable = document.createElement('table');
        awardsTable.classList.add('awards-table');

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ['Year', 'Won', 'Show'];
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        awardsTable.appendChild(thead);

        const tbody = document.createElement('tbody');
        awards.forEach(award => {
            const row = document.createElement('tr');

            const yearCell = document.createElement('td');
            yearCell.textContent = award.year;
            row.appendChild(yearCell);

            const wonCell = document.createElement('td');
            wonCell.textContent = award.won ? 'Yes' : 'No';
            row.appendChild(wonCell);

            const showCell = document.createElement('td');
            showCell.textContent = award.show;
            row.appendChild(showCell);

            tbody.appendChild(row);
        });
        awardsTable.appendChild(tbody);
        awardsTableDiv.appendChild(awardsTable);
        actorAwardsDiv.appendChild(awardsTableDiv);
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/luca-app/main/statisticGenre/:', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch the JSON data. Status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const canvasId = `genreChart`;
                const ctx = document.getElementById(canvasId).getContext('2d');
                const labels = [];
                const values = [];
                const backgroundColors = [];

                function generateRandomColor() {
                    const r = Math.floor(Math.random() * 256);
                    const g = Math.floor(Math.random() * 256);
                    const b = Math.floor(Math.random() * 256);
                    return `rgba(${r}, ${g}, ${b}, 0.2)`;
                }

                for (const genre in data) {
                    if (data.hasOwnProperty(genre)) {
                        const genreName = genre.split(':')[0];
                        labels.push(genreName);
                        values.push(data[genre].length);
                        backgroundColors.push(generateRandomColor());
                    }
                }

                const config = {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Genre Distribution',
                            data: values,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Genre Distribution Chart'
                            }
                        },
                    },
                };

                new Chart(ctx, config);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });

        fetch('/luca-app/main/statisticAwards/:', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch the JSON data. Status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const years = Object.keys(data);
                const wonData = [];
                const showsData = [];

                years.forEach(year => {
                    wonData.push(data[year].won);
                    showsData.push(data[year].shows.length);
                });

                const ctx = document.getElementById('awardChart').getContext('2d');

                const config = {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Awards Won',
                            data: wonData,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.2)',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Number of Shows',
                            data: showsData,
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 255, 0, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Awards and Shows Over the Years'
                            }
                        }
                    }
                };

                new Chart(ctx, config);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });

        fetch('/luca-app/main/statisticPopularity/:', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData,
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch the JSON data. Status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const ctx = document.getElementById('popularityYearChart').getContext('2d');

                const labels = Object.keys(data).sort();
                const values = labels.map(year => data[year]);

                const config = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Actor Popularity by Year',
                            data: values,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Actor Popularity by Year'
                            }
                        }
                    }
                };

                new Chart(ctx, config);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
    });

    function exportChartToWebP(chartId) {
        const canvas = document.getElementById(chartId);
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/webp');
        link.download = `${chartId}.webp`;
        link.click();
    }

    async function exportChartToSVG(chartId) {
        const canvas = document.getElementById(chartId);
        const ctx = canvas.getContext('2d');
        const dataUrl = canvas.toDataURL('image/png');
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}">
                        <foreignObject width="100%" height="100%">
                            <img src="${dataUrl}" width="100%" height="100%"/>
                        </foreignObject>
                     </svg>`;
        const svgBlob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
        const svgUrl = URL.createObjectURL(svgBlob);
        const link = document.createElement('a');
        link.href = svgUrl;
        link.download = `${chartId}.svg`;
        link.click();
        URL.revokeObjectURL(svgUrl);
    }

    function exportChartToCSV(chartId) {
        const chart = Chart.getChart(chartId);
        const data = chart.data;
        let csvContent = "data:text/csv;charset=utf-8,";
        data.labels.forEach((label, index) => {
            let row = `${label},${data.datasets[0].data[index]}`;
            csvContent += row + "\r\n";
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `${chartId}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
